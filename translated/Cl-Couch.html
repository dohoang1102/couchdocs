<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Cl-Couch</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#getting-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <!-- ## page was renamed from Cl-CouchDb -->

<p>Go to the official <a href="http://common-lisp.net/project/cl-couch/">Cl-couch page on common-lisp.net</a></p>
<h1 id="overview">Overview</h1>
<p><a class="internal" href="Cl-Couch.html">Cl-Couch</a> is a Common Lisp suite for interacting with CouchDB databases.</p>
<p>It defines three systems: </p>
<ul>
<li><code>cl-couchdb-client</code> -- a client server for making requests to a CouchDB database from Common Lisp</li>
<li><code>cl-couchdb-view-server</code> -- a view server for programming CouchDB <a class="internal" href="Views.html">Views</a> with Common Lisp</li>
<li><code>cl-couchdb-object-layer</code> -- a simple object layer for making <code>cl-couchdb-client</code> easier to work with</li>
</ul>
<h1 id="getting">Getting</h1>
<p>There are no official releases of <a class="internal" href="Cl-Couch.html">Cl-Couch</a> yet.</p>
<p>Check out the latest version from the <a href="http://common-lisp.net/cgi-bin/darcsweb/darcsweb.cgi?r=cl-couch-cl-couch;a=tree">darcs repo</a>:</p>
<div class="codehilite"><pre>darcs get <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://www.common-lisp.net/project/cl-couch/darcs/cl-couch&quot;</span><span class="nt">&gt;</span>http://www.common-lisp.net/project/cl-couch/darcs/cl-couch<span class="nt">&lt;/a&gt;</span>
</pre></div>


<h2 id="cl-couchdb-client">Cl-CouchDB-client</h2>
<p><code>Cl-CouchDB-client</code> allows the user to make requests to the running CouchDB server from lisp. It's main entry point is the macro <code>R</code>.</p>
<h3 id="starting-the-server">Starting the server</h3>
<p>You start the server with by calling <code>open-server</code>:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="nb">open</span><span class="o">-</span><span class="n">server</span><span class="p">)</span>

<span class="o">*</span><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">*</span>
</pre></div>


<p>This sets <code>*COUCHDB-SERVER*</code> to the default http://localhost:5984. This isn't really necessary, but allows us to omit the server argument when we make requests.</p>
<h3 id="couch-request">COUCH-REQUEST</h3>
<p><code>COUCH-REQUEST</code> takes specifiers for a request to a CouchDB database and returns a Lisp object. HTTP PUT and POST requests with <code>COUCH-REQUEST</code> take Lisp objects as well, thus enabling the programmer to black-box the JSON layer completely.</p>
<h4 id="examples">Examples</h4>
<p>Using <code>COUCH-REQUEST</code> to make a GET request to <code>http://localhost:5984/blog/150fedd5d14f0771eb5e44d071a1df5d</code>:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">CLIENT</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">couch</span><span class="o">-</span><span class="n">request</span> <span class="p">:</span><span class="n">get</span> <span class="p">(</span><span class="n">blog</span> <span class="s">&quot;150fedd5d14f0771eb5e44d071a1df5d&quot;</span><span class="p">))</span>
<span class="p">((:</span><span class="n">_ID</span> <span class="o">.</span> <span class="s">&quot;150fedd5d14f0771eb5e44d071a1df5d&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">_REV</span> <span class="o">.</span> <span class="s">&quot;253381451&quot;</span><span class="p">)</span>
 <span class="p">(:</span><span class="n">AUTHOR</span> <span class="o">.</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">BODY</span> <span class="o">.</span> <span class="s">&quot;Zażółć&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">POST</span> <span class="o">.</span> <span class="s">&quot;third&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">TYPE</span> <span class="o">.</span> <span class="s">&quot;comment&quot;</span><span class="p">)</span>
 <span class="p">(:</span><span class="n">N</span> <span class="o">.</span> <span class="mi">66</span><span class="p">))</span>
</pre></div>


<p>Using <code>COUCH-REQUEST</code> to make a GET request to <code>http://localhost:5984/blog/_all_docs?count=2</code>:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">CLIENT</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">couch</span><span class="o">-</span><span class="n">request</span> <span class="p">:</span><span class="n">get</span> <span class="p">(</span><span class="n">blog</span> <span class="n">_all_docs</span> <span class="p">:</span><span class="n">count</span> <span class="mi">2</span><span class="p">))</span>
<span class="p">((:</span><span class="n">TOTAL</span><span class="o">-</span><span class="n">ROWS</span> <span class="o">.</span> <span class="mi">48</span><span class="p">)</span> <span class="p">(:</span><span class="n">OFFSET</span> <span class="o">.</span> <span class="mi">0</span><span class="p">)</span>
 <span class="p">(:</span><span class="n">ROWS</span>
  <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;06672346ffc093ce68a07692a5f12db5&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">KEY</span> <span class="o">.</span> <span class="s">&quot;06672346ffc093ce68a07692a5f12db5&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">REV</span> <span class="o">.</span> <span class="s">&quot;3441371051&quot;</span><span class="p">)))</span>
  <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;14328cab564dfec5eac0ff0a44d2083d&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">KEY</span> <span class="o">.</span> <span class="s">&quot;14328cab564dfec5eac0ff0a44d2083d&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">REV</span> <span class="o">.</span> <span class="s">&quot;1258191009&quot;</span><span class="p">)))))</span>
</pre></div>


<h3 id="couch-request_1">COUCH-REQUEST*</h3>
<p><code>COUCH-REQUEST*</code> is the functional equivalent to the macro <code>COUCH-REQUEST</code>.</p>
<h3 id="">@</h3>
<p><code>@</code> is a utility function that enables you to access Lisp data in the JavaScript dot style. For example,
<code>(@ doc :friend :id)</code> is equivalent to js <code>doc.friend.id</code>.</p>
<p>When looking into lists, <code>@</code> does an alist lookup by default. Since it's a generic function, however, it's behavior can be extended for any type of object (eg, those created from CouchDB documents by <code>cl-CouchDB-object-layer</code>).</p>
<h2 id="cl-couchdb-view-server">Cl-CouchDB-View-Server</h2>
<p><code>Cl-CouchDB-View-Server</code> enables you to write views with Common Lisp instead of having to use JavaScript. It supports both standard and mapreduce views.</p>
<p>Writing views with Common Lisp has several advantages:</p>
<ul>
<li>Common Lisp compiles to fast code.</li>
<li>Views are compiled (even ad hoc views) since CouchDB usually sends symbols naming functions, rather than their source.</li>
<li>You can do all sorts of weird tricks with the running Lisp image, such as maintaining an in-memory database for faster indexed lookup, making requests to the CouchDB server itself, or well... any of the weird things you can do with Lisp...</li>
</ul>
<h3 id="starting-the-lisp-view-server">Starting the Lisp View Server</h3>
<h4 id="from-the-couchdb-side">From the CouchDB side</h4>
<p>A Lisp image that with a running view server will be listening to port 5477. So, you need to add something like </p>
<div class="codehilite"><pre><span class="n">common</span><span class="o">-</span><span class="n">lisp</span><span class="o">=</span><span class="sr">/usr/</span><span class="n">bin</span><span class="o">/</span><span class="n">socat</span> <span class="o">-</span> <span class="n">TCP4:localhost:5477</span>
</pre></div>


<p>to the <code>[Couch Query Servers]</code> section of your <code>couch.ini</code> (you can substitute socat for any program that will allow a
socket open on port 5477 look like a program with standard input and standard output).<br />
</p>
<p><strong>Update: </strong> As of CouchDB 0.9.0, the configuration file has been replaced with a combination of <code>default.ini</code> and <code>local.ini</code>.  The line above needs to be added to the <code>local.ini</code> file under the <code>[query_servers]</code> section instead.  Restart the CouchDB server and make sure common-lisp is listed next to the query_servers field in the configuration page in Futon.</p>
<h4 id="from-the-lisp-side">From the Lisp Side</h4>
<p>The Lisp image just needs to open a client server (we need to be able to speak with couchdb through HTTP) and a view server and it's ready for action.</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="nb">open</span><span class="o">-</span><span class="n">server</span><span class="p">)</span>

<span class="o">*</span><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">*</span>

<span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">start</span><span class="o">-</span><span class="n">view</span><span class="o">-</span><span class="n">server</span><span class="p">)</span>
<span class="o">&lt;!--</span> <span class="c1">#&lt;view-server :host &quot;127.0.0.1&quot; :port 5477&gt; --&gt;</span>
</pre></div>


<h3 id="creating-design-documents">Creating Design Documents</h3>
<p>The <code>DEFDESIGN</code> macro creates a design document and saves it to the database.</p>
<p>This example creates a design document "test" with one view (<code>by-author-type</code>) and saves it to the database "blog":</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">defdesign</span> <span class="n">test</span>
            <span class="p">((</span><span class="n">by</span><span class="o">-</span><span class="n">author</span><span class="o">-</span><span class="n">type</span> <span class="p">:</span><span class="nb">map</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span>
                     <span class="p">(</span><span class="n">emit</span> <span class="p">(</span><span class="n">list</span> <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">author</span><span class="p">)</span> <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">type</span><span class="p">))</span> <span class="n">doc</span><span class="p">)))</span>
          <span class="p">(:</span><span class="n">documentation</span> <span class="s">&quot;A test view.&quot;</span><span class="p">)</span>
          <span class="p">(:</span><span class="n">sync</span> <span class="n">blog</span><span class="p">))</span>
<span class="o">&lt;!--</span> <span class="c1">#&lt;design-document :name TEST :revision NIL :views (#&lt;view BY-AUTHOR-TYPE :map &quot;#&#39;CL-COUCHDB-VIEW-SERVER::BY-AUTHOR-TYPE-MAP&quot; :reduce NIL&gt;)&gt; --&gt;</span>
</pre></div>


<p>A <code>:reduce</code> view-function may be called either in the <code>reduce</code> or <code>rereduce</code> phase. In the latter situations it gets as its argument the list of earlier calls to reduce instead the usual list of key-value pairs produced by <code>map</code>. The function may tell whether this is the case by checking the value of the special variable <code>*in-rereduce*</code>.</p>
<h3 id="querying-the-view-server">Querying the View Server</h3>
<p>You can query views with the function <code>query-view</code>:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">query</span><span class="o">-</span><span class="n">view</span> <span class="s">&#39;by-author-type :startkey &#39;</span><span class="p">(</span><span class="s">&quot;foobar&quot;</span><span class="p">)</span> <span class="p">:</span><span class="n">endkey</span> <span class="err">&#39;</span><span class="p">(</span><span class="s">&quot;foobar&quot;</span> <span class="c1">#()))</span>
<span class="p">(((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;first&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="s">&quot;foobar&quot;</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">_ID</span> <span class="o">.</span> <span class="s">&quot;first&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">_REV</span> <span class="o">.</span> <span class="s">&quot;2718626630&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">AUTHOR</span> <span class="o">.</span> <span class="s">&quot;foobar&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">BODY</span> <span class="o">.</span> <span class="s">&quot;Zażółć gęślą jaźń&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">TYPE</span> <span class="o">.</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">N</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)))</span>
 <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;fourth&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="s">&quot;foobar&quot;</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">_ID</span> <span class="o">.</span> <span class="s">&quot;fourth&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">_REV</span> <span class="o">.</span> <span class="s">&quot;2695588251&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">AUTHOR</span> <span class="o">.</span> <span class="s">&quot;foobar&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">BODY</span> <span class="o">.</span> <span class="s">&quot;Zażółć gęślą jaźń&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">TYPE</span> <span class="o">.</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">N</span> <span class="o">.</span> <span class="mi">8</span><span class="p">)))</span>
 <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;second&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="s">&quot;foobar&quot;</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">_ID</span> <span class="o">.</span> <span class="s">&quot;second&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">_REV</span> <span class="o">.</span> <span class="s">&quot;230136489&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">AUTHOR</span> <span class="o">.</span> <span class="s">&quot;foobar&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">BODY</span> <span class="o">.</span> <span class="s">&quot;Zażółć gęślą jaźń&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">TYPE</span> <span class="o">.</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">N</span> <span class="o">.</span> <span class="mi">6</span><span class="p">)))</span>
 <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;third&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="s">&quot;foobar&quot;</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="p">(:</span><span class="n">_ID</span> <span class="o">.</span> <span class="s">&quot;third&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">_REV</span> <span class="o">.</span> <span class="s">&quot;2453743212&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">AUTHOR</span> <span class="o">.</span> <span class="s">&quot;foobar&quot;</span><span class="p">)</span>
   <span class="p">(:</span><span class="n">BODY</span> <span class="o">.</span> <span class="s">&quot;Zażółć gęślą jaźń&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">TYPE</span> <span class="o">.</span> <span class="s">&quot;blogPost&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">N</span> <span class="o">.</span> <span class="mi">7</span><span class="p">))))</span>
<span class="mi">47</span>
<span class="mi">39</span>
</pre></div>


<p>You can create ad-hoc views with the function <code>query</code>:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">SERVER</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">query</span> <span class="s">&#39;blog &#39;</span><span class="p">(</span><span class="n">lambda</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="p">(</span><span class="n">emit</span> <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">author</span><span class="p">)</span> <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">body</span><span class="p">)))</span> <span class="p">:</span><span class="n">count</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;06672346ffc093ce68a07692a5f12db5&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="o">.</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="o">.</span> <span class="s">&quot;Zażółć&quot;</span><span class="p">))</span>
 <span class="p">((:</span><span class="n">ID</span> <span class="o">.</span> <span class="s">&quot;146238e235f0cc36661ce82c909044be&quot;</span><span class="p">)</span> <span class="p">(:</span><span class="n">KEY</span> <span class="o">.</span> <span class="s">&quot;foo&quot;</span><span class="p">)</span>
  <span class="p">(:</span><span class="n">VALUE</span> <span class="o">.</span> <span class="s">&quot;Zażółć&quot;</span><span class="p">)))</span>
<span class="mi">47</span>
<span class="mi">0</span>
</pre></div>


<h2 id="cl-couchdb-object-layer">Cl-CouchDB-Object-Layer</h2>
<p><code>Cl-CouchDB-Object-Layer</code> provides an object abstraction layer over the alists coming in and out of the database. Most importantly, using these objects (called <code>docs</code>) allows you to automatically validate the information coming in and out of the database (preventing other Lispers from polluting your pristine CouchDB database with specious data ;-) )</p>
<h3 id="defining-doc-classes">Defining Doc Classes</h3>
<p>To define a doc class, use <code>DEFDOC</code> (which is similar to <a href="http://www.lisp.org/HyperSpec/Body/mac_defclass.html">DEFCLASS</a>).</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">OBJECTS</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">defdoc</span> <span class="n">blog</span><span class="o">-</span><span class="n">post</span> 
             <span class="p">((:</span><span class="n">author</span> <span class="p">:</span><span class="n">validator</span> <span class="c1">#&#39;stringp)</span>
              <span class="p">(:</span><span class="n">title</span> <span class="p">:</span><span class="n">validator</span> <span class="c1">#&#39;stringp)</span>
              <span class="p">(:</span><span class="n">_id</span> <span class="p">:</span><span class="n">initform</span> <span class="p">(</span><span class="n">lambda</span> <span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="p">(</span><span class="n">url</span><span class="o">-</span><span class="n">encode</span> <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">title</span><span class="p">))))</span>
              <span class="p">(:</span><span class="n">body</span> <span class="p">:</span><span class="n">validator</span> <span class="c1">#&#39;stringp))</span>
           <span class="p">(:</span><span class="n">default</span><span class="o">-</span><span class="n">db</span> <span class="err">&#39;</span><span class="n">blog</span><span class="p">))</span>
<span class="o">&lt;!--</span> <span class="c1">#&lt;STANDARD-METHOD MAKE-DOC ((EQL BLOG-POST)) {BEB6679}&gt; --&gt;</span>
</pre></div>


<p>"Attributes" are like slots, except identified by a keyword. Attributes can have a <code>:VALIDATOR</code> and <code>:INITFORM</code> and <code>:DOCUMENTATION</code> attribute-options (which are liks slot-options for CLOS objects).</p>
<ul>
<li>A <code>:VALIDATOR</code> must be a unary function that take the value of an attribute and returns a non-<code>NULL</code> value if it is valid.</li>
<li>An <code>:INITFORM</code> may be either a normal Lisp value or unary function, which is called on the object itself after setting other attributes.</li>
<li>a <code>:DOCUMENTATION</code> attribute-option is a doc string.</li>
</ul>
<h3 id="making-docs">Making Docs</h3>
<p>Use the function <code>MAKE-DOC</code> to make <code>DOC</code>s. <code>MAKE-DOC</code> is something like <a href="http://www.lisp.org/HyperSpec/Body/stagenfun_make-instance.html">MAKE-INSTANCE</a>.</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">OBJECTS</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">make</span><span class="o">-</span><span class="n">doc</span> <span class="err">&#39;</span><span class="n">blog</span><span class="o">-</span><span class="n">post</span> <span class="p">:</span><span class="n">author</span> <span class="s">&quot;Kuba&quot;</span> <span class="p">:</span><span class="n">title</span> <span class="s">&quot;O czym dziś napisać&quot;</span> <span class="p">:</span><span class="n">body</span> <span class="s">&quot;Foo&quot;</span><span class="p">)</span>
<span class="o">&lt;!--</span> <span class="c1">#&lt;doc(NIL) :_ID &quot;o_czym_dzis_napisac&quot; :BODY &quot;Foo&quot; :TITLE &quot;O czym dziś napisać&quot; :AUTHOR &quot;Kuba&quot; :TYPE &quot;BLOG-POST&quot;&gt; --&gt;</span>
</pre></div>


<h3 id="getting-data-from-docs">Getting Data from Docs</h3>
<p>You can call <code>@</code> on docs to get the value of an attribute, exactly as you would call <code>@</code> on an alist.</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">OBJECTS</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">let</span> <span class="p">((</span><span class="n">doc</span> <span class="p">(</span><span class="n">make</span><span class="o">-</span><span class="n">doc</span> <span class="err">&#39;</span><span class="n">blog</span><span class="o">-</span><span class="n">post</span> <span class="p">:</span><span class="n">author</span> <span class="s">&quot;Kuba&quot;</span> <span class="p">:</span><span class="n">title</span> <span class="s">&quot;O czym dziś napisać&quot;</span> <span class="p">:</span><span class="n">body</span> <span class="s">&quot;Foo&quot;</span><span class="p">)))</span>
           <span class="p">(</span><span class="nv">@</span> <span class="nv">doc</span> <span class="p">:</span><span class="n">title</span><span class="p">))</span>
<span class="s">&quot;O czym dziś napisać&quot;</span>
</pre></div>


<h3 id="saving-docs">Saving Docs</h3>
<p>We can call <code>make-and-save</code> to create a document and save it in the database:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">OBJECTS</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">make</span><span class="o">-</span><span class="n">doc</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">save</span> <span class="s">&#39;blog-post :author &quot;Kuba&quot; :title &quot;Zażółć gęślą jaźń&quot; :body &quot;foobar&quot;) ;we&#39;</span><span class="n">ll</span> <span class="n">get</span> <span class="n">the</span> <span class="n">rev</span> <span class="n">in</span> <span class="k">return</span>
<span class="s">&quot;2591270477&quot;</span>
</pre></div>


<p>Note: if an object is invalid, it won't be saved:</p>
<div class="codehilite"><pre><span class="n">COUCHDB</span><span class="o">-</span><span class="n">OBJECTS</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">make</span><span class="o">-</span><span class="n">doc</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">save</span> <span class="s">&#39;blog-post :author &quot;Kuba&quot; :title &quot;Zażółć gęślą jaźń&quot;)</span>
<span class="s">The document #&lt;doc(NIL) :_ID &quot;zazolc_gesla_jazn&quot; :TITLE &quot;Zażółć gęślą jaźń&quot; :AUTHOR &quot;Kuba&quot; :TYPE &quot;BLOG-POST&quot;&gt; is invalid. Reason: attribute</span>
<span class="s">              :BODY with value NIL didn&#39;</span><span class="n">t</span> <span class="n">validate</span> <span class="n">using</span> <span class="c1">#&lt;FUNCTION STRINGP&gt;</span>
   <span class="p">[</span><span class="n">Condition</span> <span class="n">of</span> <span class="n">type</span> <span class="n">VALIDATOR</span><span class="o">-</span><span class="n">FAILED</span><span class="p">]</span>
<span class="o">...</span>
</pre></div>


<h1 id="license">License</h1>
<p>BSD sans advertising clause.</p>
<h1 id="author">Author</h1>
<p>Ryszard Szopa <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#114;&#121;&#115;&#122;&#97;&#114;&#100;&#46;&#115;&#122;&#111;&#112;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#114;&#121;&#115;&#122;&#97;&#114;&#100;&#46;&#115;&#122;&#111;&#112;&#97;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>, with one component (logv)
being authored by Nick Allen <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#97;&#108;&#108;&#101;&#110;&#48;&#53;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#110;&#97;&#108;&#108;&#101;&#110;&#48;&#53;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a>.</p>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>