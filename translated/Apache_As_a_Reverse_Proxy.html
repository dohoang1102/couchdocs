<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Apache_As_a_Reverse_Proxy</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>By Patrick Antivackis:</p>
<p>This is a Virtual Host config to use Apache as a reverse Proxy for CouchDB.
You need at least to configure apache with the --enable-proxy --enable-proxy-http options and use a version equal or higher than Apache 2.2.7
in order to use the nocanon option in the proxypass directive.</p>
<div class="codehilite"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
   ServerAdmin webmaster@dummy-host.example.com
   DocumentRoot &quot;/opt/websites/web/www/dummy&quot;
   ServerName couchdb.localhost
   AllowEncodedSlashes On
   ProxyRequests Off
   KeepAlive Off
   <span class="nt">&lt;Proxy</span> <span class="err">*</span><span class="nt">&gt;</span>
      Order deny,allow
      Deny from all
      Allow from 127.0.0.1
   <span class="nt">&lt;/Proxy&gt;</span>
   ProxyPass / http://localhost:5984/ nocanon
   ProxyPassReverse / http://localhost:5984/
   ErrorLog &quot;logs/couchdb.localhost-error_log&quot;
   CustomLog &quot;logs/couchdb.localhost-access_log&quot; common
<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>Note from Wout Mertens:
I tried the above, but I had lots of tests fail on Apache 2.2.8/Solaris. When I removed the nocanon directive, less tests failed. I'm not in a position to upgrade Apache just now so I can't test with newer versions.</p>
<p>Note from Rune Larsen:
On linux Apache 2.2.10 you must use nocanon - otherwise many tests fail.</p>
<p>Note from Thomas Lang:
I had to remove the trailing slashes on ProxyPass and ProxyPassReverse in order to get a request to '/_uuids' give the right response. Changed lines:</p>
<div class="codehilite"><pre><span class="n">ProxyPass</span> <span class="sr">/ http:/</span><span class="o">/</span><span class="n">localhost:5984</span> <span class="n">nocanon</span>
<span class="n">ProxyPassReverse</span> <span class="sr">/ http:/</span><span class="o">/</span><span class="n">localhost:5984</span>
</pre></div>


<p>Before this change apache would add an extra slash before every request to a resource beginning with '_', resulting in this: 'GET' //_utils 500</p>
<h2 id="apache-reverse-proxy-for-same-origin-and-authentication">Apache Reverse Proxy for same origin and authentication</h2>
<p>Browsers will typically enforce the same origin policy and will reject requests to fetch data unless the protocol, port and host are identical to the source of the current page.  Using a reverse proxy allows browser-hosted applications to access CouchDB while conforming to the same origin policy.</p>
<p>The following snippet will:</p>
<ul>
<li>Require validation of all users, checking username and password against the contents of /var/auth/digest_pw.</li>
<li>Forward any requests that start with /db/ to CouchDB.</li>
<li>Add user=username to the list of parameters to any request to CouchDB for use with a custom authentication_handler.</li>
</ul>
<p>The snippet requires that the proxy, proxy_http, rewrite and auth_digest modules be enabled.</p>
<div class="codehilite"><pre><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
    ServerAdmin webmaster@localhost
...

     <span class="nt">&lt;Location</span> <span class="nt">/&gt;</span>
           AuthType Digest
           AuthName &quot;CouchDB&quot;
       AuthDigestDomain /
           AuthDigestProvider file
           AuthUserFile /var/auth/digest_pw
           Require valid-user
     <span class="nt">&lt;/Location&gt;</span>

     BrowserMatch &quot;MSIE&quot; AuthDigestEnableQueryStringHack=On

    ProxyRequests Off
    <span class="nt">&lt;Proxy</span> <span class="err">*</span><span class="nt">&gt;</span>
           Order Allow,Deny
           Allow from all
    <span class="nt">&lt;/Proxy&gt;</span>

     RewriteEngine On
     RewriteOptions Inherit

     RewriteRule ^/db/(.*) http://127.0.0.1:5984/$1?user=%{LA-U:REMOTE_USER} [QSA,P]

<span class="nt">&lt;/VirtualHost&gt;</span>
</pre></div>


<p>If you are implementing your own security layer by using a reverse proxy, you might need to disable the default authentication handlers of couchdb, otherwise the user might get queried twice about credentials:</p>
<div class="codehilite"><pre><span class="k">[httpd]</span>
<span class="na">authentication_handlers</span> <span class="o">=</span> <span class="s">{couch_httpd_auth, null_authentication_handler}</span>
</pre></div>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>