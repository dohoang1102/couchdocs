<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - How_to_replicate_a_database</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>The documented way to do replication is available at this URL <a href="http://wiki.apache.org/couchdb/Frequently_asked_questions#how_replication">here</a></p>
<h2 id="expanded-explanation">Expanded explanation</h2>
<p>Fire up Futon and head over to the replication option. The URL is http://localhost:5984/_utils/replicator.html</p>
<p>The replication option prompts you to either specify a CouchDB instance to push towards or a CouchDB instance to pull from. If the replication is not within the same CouchDB instance you will need to specific a URI.
The correct format for the URI is: http://<address>:<port>/<database name></p>
<p><em>remote database:</em> http://192.168.197.132:5984/test_suite_db_b to <em>local database:</em> test_suite_db_b</p>
<p>This will replicate the information at the remote database URI to the local database test_suite_db_b.</p>
<p>It is important to specific the database name in the URL as Futon does not assume anything with respect to the source or destination database based upon the originating or destination database.</p>
<h2 id="operational-hints">Operational Hints</h2>
<p>Replication is one-way. In a multi-master scenario you have to issue one replication from A to B, and a separate one from B to A.</p>
<p>Currently it seems that "pull" replication where you have a remote source and and a local target is much more reliable than "push" where you have it the other way around.</p>
<h2 id="playing-with-replication">Playing with Replication</h2>
<p>You may replicate between two databases in the same couchdb instance.</p>
<p>However if you prefer a more realistic test, you can also set up two test couchdb instances on the same machine and replicate between them. Here is local1.ini:</p>
<div class="codehilite"><pre><span class="p">;</span> <span class="n">Remember</span> <span class="n">to</span> <span class="n">create</span> <span class="n">the</span> <span class="n">directories:</span>
<span class="p">;</span>   <span class="nb">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb1/</span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="nb">log</span><span class="p">}</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">Start</span> <span class="n">using:</span>
<span class="p">;</span>   <span class="n">couchdb</span> <span class="o">-</span><span class="n">c</span> <span class="sr">/usr/</span><span class="nb">local</span><span class="sr">/etc/co</span><span class="n">uchdb</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">ini</span> <span class="o">-</span><span class="n">c</span> <span class="n">local1</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="n">couchdb</span><span class="p">]</span>
<span class="n">database_dir</span> <span class="o">=</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb1/</span><span class="n">data</span>

<span class="p">[</span><span class="nb">log</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb1/</span><span class="nb">log</span><span class="o">/</span><span class="n">couch</span><span class="o">.</span><span class="nb">log</span>

<span class="p">[</span><span class="n">httpd</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5001</span>
</pre></div>


<p>Similarly local2.ini:</p>
<div class="codehilite"><pre><span class="p">;</span> <span class="n">Remember</span> <span class="n">to</span> <span class="n">create</span> <span class="n">the</span> <span class="n">directories:</span>
<span class="p">;</span>   <span class="nb">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb2/</span><span class="p">{</span><span class="n">data</span><span class="p">,</span><span class="nb">log</span><span class="p">}</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">Start</span> <span class="n">using:</span>
<span class="p">;</span>   <span class="n">couchdb</span> <span class="o">-</span><span class="n">c</span> <span class="sr">/usr/</span><span class="nb">local</span><span class="sr">/etc/co</span><span class="n">uchdb</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">ini</span> <span class="o">-</span><span class="n">c</span> <span class="n">local2</span><span class="o">.</span><span class="n">ini</span>

<span class="p">[</span><span class="n">couchdb</span><span class="p">]</span>
<span class="n">database_dir</span> <span class="o">=</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb2/</span><span class="n">data</span>

<span class="p">[</span><span class="nb">log</span><span class="p">]</span>
<span class="n">file</span> <span class="o">=</span> <span class="sr">/var/</span><span class="n">tmp</span><span class="sr">/couchdb2/</span><span class="nb">log</span><span class="o">/</span><span class="n">couch</span><span class="o">.</span><span class="nb">log</span>

<span class="p">[</span><span class="n">httpd</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5002</span>
</pre></div>


<p>Test they are both running:</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="o">/</span>
<span class="p">{</span><span class="s">&quot;couchdb&quot;</span><span class="p">:</span><span class="s">&quot;Welcome&quot;</span><span class="p">,</span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="s">&quot;0.9.0a738034-incubating&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="o">/</span>
<span class="p">{</span><span class="s">&quot;couchdb&quot;</span><span class="p">:</span><span class="s">&quot;Welcome&quot;</span><span class="p">,</span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="s">&quot;0.9.0a738034-incubating&quot;</span><span class="p">}</span>
</pre></div>


<h3 id="create-and-replicate-a-document">Create and replicate a document</h3>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="o">/</span><span class="n">sampledb</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="o">/</span><span class="n">sampledb</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>

<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;hello&quot;:&quot;world&quot;}&#39;</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;3851869530&quot;</span><span class="p">}</span>

<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;source&quot;:&quot;http://127.0.0.1:5001/sampledb&quot;,&quot;target&quot;:&quot;sampledb&quot;}&#39;</span> <span class="o">\</span>
    <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="o">/</span><span class="n">_replicate</span>
<span class="p">{</span>
  <span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span>
  <span class="s">&quot;session_id&quot;</span><span class="p">:</span><span class="s">&quot;7118d54c40761eba83454aabae8ea91b&quot;</span><span class="p">,</span>
  <span class="s">&quot;source_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
  <span class="s">&quot;history&quot;</span><span class="p">:</span>
  <span class="p">[</span>
    <span class="p">{</span>
      <span class="s">&quot;start_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:26:09 GMT&quot;</span><span class="p">,</span>
      <span class="s">&quot;end_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:26:09 GMT&quot;</span><span class="p">,</span>
      <span class="s">&quot;start_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="s">&quot;end_last_seq&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="s">&quot;missing_checked&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="s">&quot;missing_found&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="s">&quot;docs_read&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="s">&quot;docs_written&quot;</span><span class="p">:</span><span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p><em>POST response has been reformatted for clarity</em></p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;3851869530&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;world&quot;</span><span class="p">}</span> 
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5002</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;3851869530&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;world&quot;</span><span class="p">}</span>
</pre></div>


<h3 id="introduce-conflicting-updates">Introduce conflicting updates</h3>
<p>''Note: the updates have to be made on separate databases. Update conflicts can't occur within a single database; because you provide the original _rev, if someone else has already changed the document, the second update is rejected.''</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;_rev&quot;:&quot;3851869530&quot;,&quot;hello&quot;:&quot;fred&quot;}&#39;</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;132006080&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;_rev&quot;:&quot;3851869530&quot;,&quot;hello&quot;:&quot;jim&quot;}&#39;</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">}</span>

<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;source&quot;:&quot;http://127.0.0.1:5001/sampledb&quot;,&quot;target&quot;:&quot;sampledb&quot;}&#39;</span> <span class="o">\</span>
    <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="o">/</span><span class="n">_replicate</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;session_id&quot;</span><span class="p">:</span><span class="s">&quot;fe1ec1c66b0b916e7e87dd635b4dc572&quot;</span><span class="p">,</span><span class="s">&quot;source_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;history&quot;</span><span class="p">:</span>
<span class="p">[{</span><span class="s">&quot;start_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:28:36 GMT&quot;</span><span class="p">,</span><span class="s">&quot;end_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:28:36 GMT&quot;</span><span class="p">,</span>
<span class="s">&quot;start_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;end_last_seq&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;missing_checked&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;missing_found&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;docs_read&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;docs_written&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}]}</span>

<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;132006080&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;fred&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5002</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">}</span>
</pre></div>


<p>At this point you can see the two databases still have different ideas about this document. You need to replicate back the other way as well:</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;target&quot;:&quot;http://127.0.0.1:5001/sampledb&quot;,&quot;source&quot;:&quot;sampledb&quot;}&#39;</span> <span class="o">\</span>
    <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="o">/</span><span class="n">_replicate</span>

<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;session_id&quot;</span><span class="p">:</span><span class="s">&quot;da0a07a0f9c9fb5c2d2e2769229257df&quot;</span><span class="p">,</span><span class="s">&quot;source_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;history&quot;</span><span class="p">:</span>
<span class="p">[{</span><span class="s">&quot;start_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:30:23 GMT&quot;</span><span class="p">,</span><span class="s">&quot;end_time&quot;</span><span class="p">:</span><span class="s">&quot;Wed, 28 Jan 2009 16:30:23 GMT&quot;</span><span class="p">,</span>
<span class="s">&quot;start_last_seq&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;end_last_seq&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s">&quot;missing_checked&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;missing_found&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;docs_read&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;docs_written&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}]}</span>

<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">revs</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">,</span><span class="s">&quot;_revs&quot;</span><span class="p">:[</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;3851869530&quot;</span><span class="p">]}</span>
<span class="mi">3</span><span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5002</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">revs</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">,</span><span class="s">&quot;_revs&quot;</span><span class="p">:[</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;3851869530&quot;</span><span class="p">]}</span>
</pre></div>


<p>The two machines now agree on one document and revision history, but the conflict (and conflicting version) is not shown. You have to ask for this explicitly with <em>conflicts=true</em></p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">,</span><span class="s">&quot;_conflicts&quot;</span><span class="p">:[</span><span class="s">&quot;132006080&quot;</span><span class="p">]}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5002</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">,</span><span class="s">&quot;_conflicts&quot;</span><span class="p">:[</span><span class="s">&quot;132006080&quot;</span><span class="p">]}</span>
</pre></div>


<h3 id="compaction">Compaction</h3>
<p>The conflict status, and the conflicting versions, remain even after compaction. However the very original version, which was not in conflict, does not.</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="sr">/sampledb/</span><span class="n">_compact</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5002</span><span class="sr">/sampledb/</span><span class="n">_compact</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">,</span><span class="s">&quot;_conflicts&quot;</span><span class="p">:[</span><span class="s">&quot;132006080&quot;</span><span class="p">]}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">rev</span><span class="o">=</span><span class="mi">132006080</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;132006080&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;fred&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">rev</span><span class="o">=</span><span class="mi">2575525432</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;2575525432&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;jim&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">rev</span><span class="o">=</span><span class="mi">3851869530</span>
<span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="s">&quot;{not_found,missing}&quot;</span><span class="p">,</span><span class="s">&quot;reason&quot;</span><span class="p">:</span><span class="s">&quot;3851869530&quot;</span><span class="p">}</span>
</pre></div>


<h3 id="conflict-resolution">Conflict Resolution</h3>
<p>All nodes see the same conflict state and history, so any of them can resolve the conflict.</p>
<p>Nodes can continue to add new versions, but conflict remains:</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="s">&#39;{&quot;_rev&quot;:&quot;2575525432&quot;,&quot;hello&quot;:&quot;resolved&quot;}&#39;</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;923422654&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;923422654&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;resolved&quot;</span><span class="p">,</span><span class="s">&quot;_conflicts&quot;</span><span class="p">:[</span><span class="s">&quot;132006080&quot;</span><span class="p">]}</span>
</pre></div>


<p>Once the application is satisfied that it has resolved the conflict, it simply has to DELETE the conflicting revision. Couch actually keeps a separate list of deleted conflict revisions that you can view with "deleted_conflicts=true"</p>
<div class="codehilite"><pre><span class="nv">$</span> <span class="nv">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">DELETE</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">rev</span><span class="o">=</span><span class="mi">132006080</span>
<span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;3699698383&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;804871722&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;resolved&quot;</span><span class="p">}</span>
<span class="nv">$</span> <span class="nv">curl</span> <span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5001</span><span class="sr">/sampledb/</span><span class="n">doc1</span><span class="p">?</span><span class="n">deleted_conflicts</span><span class="o">=</span><span class="n">true</span>
<span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;doc1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;804871722&quot;</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">:</span><span class="s">&quot;resolved&quot;</span><span class="p">,</span><span class="s">&quot;_deleted_conflicts&quot;</span><span class="p">:[</span><span class="s">&quot;3699698383&quot;</span><span class="p">]}</span>
</pre></div>


<h3 id="sample-shell-script">Sample shell script</h3>
<p>Running this script gives an easy way to set up a replication conflict so you can examine it and resolve it.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="codehilite"><pre><span class="c">&lt;!-- #!/bin/sh --&gt;</span>

set -xe

HOST1=http://localhost:5001
HOST2=http://localhost:5002
LOCAL1=sampledb
LOCAL2=sampledb
DB1=&quot;<span class="nv">$HOST1</span>/<span class="nv">$LOCAL1</span>&quot;
DB2=&quot;<span class="nv">$HOST2</span>/<span class="nv">$LOCAL2</span>&quot;

curl -X DELETE &quot;<span class="nv">$DB1</span>&quot;
curl -X DELETE &quot;<span class="nv">$DB2</span>&quot;
curl -X PUT &quot;<span class="nv">$DB1</span>&quot;
curl -X PUT &quot;<span class="nv">$DB2</span>&quot;

resp=`curl -sX PUT -d &quot;{\&quot;hello\&quot;:\&quot;world\&quot;}&quot; &quot;<span class="cp">${</span><span class="n">DB1</span><span class="cp">}</span>/doc1&quot;`
echo &quot;<span class="nv">$resp</span>&quot;
rev=`expr &quot;<span class="nv">$resp</span>&quot; : &#39;.*&quot;rev&quot;:&quot;\([^&quot;]*\)&quot;&#39;`

<span class="c">&lt;!-- # Replicate --&gt;</span>

curl -X POST -d &quot;{\&quot;source\&quot;:\&quot;<span class="nv">$DB1</span>\&quot;,\&quot;target\&quot;:\&quot;<span class="nv">$LOCAL2</span>\&quot;}&quot; &quot;<span class="nv">$HOST2</span>/_replicate&quot;
curl -s &quot;<span class="nv">$DB1</span>/doc1&quot; | grep world
curl -s &quot;<span class="nv">$DB2</span>/doc1&quot; | grep world

<span class="c">&lt;!-- # Now make conflicting changes --&gt;</span>

curl -sX PUT -d &quot;{\&quot;_rev\&quot;:\&quot;<span class="nv">$rev</span>\&quot;,\&quot;hello\&quot;:\&quot;fred\&quot;}&quot; &quot;<span class="cp">${</span><span class="n">DB1</span><span class="cp">}</span>/doc1&quot;
curl -sX PUT -d &quot;{\&quot;_rev\&quot;:\&quot;<span class="nv">$rev</span>\&quot;,\&quot;hello\&quot;:\&quot;jim\&quot;}&quot; &quot;<span class="cp">${</span><span class="n">DB2</span><span class="cp">}</span>/doc1&quot;
curl -s &quot;<span class="nv">$DB1</span>/doc1&quot; | grep fred
curl -s &quot;<span class="nv">$DB2</span>/doc1&quot; | grep jim

<span class="c">&lt;!-- # Replicate again, A-&gt;B. Conflict seen on B side only. --&gt;</span>

curl -X POST -d &quot;{\&quot;source\&quot;:\&quot;<span class="nv">$DB1</span>\&quot;,\&quot;target\&quot;:\&quot;<span class="nv">$LOCAL2</span>\&quot;}&quot; &quot;<span class="nv">$HOST2</span>/_replicate&quot;
echo &quot;*** On first DB ***&quot;
curl -s &quot;<span class="nv">$DB1</span>/doc1?conflicts=true&quot;
echo &quot;*** On second DB ***&quot;
curl -s &quot;<span class="nv">$DB2</span>/doc1?conflicts=true&quot;

<span class="c">&lt;!-- # Replicate again, B-&gt;A. Identical conflict on both sides. --&gt;</span>

curl -X POST -d &quot;{\&quot;target\&quot;:\&quot;<span class="nv">$DB1</span>\&quot;,\&quot;source\&quot;:\&quot;<span class="nv">$LOCAL2</span>\&quot;}&quot; &quot;<span class="nv">$HOST2</span>/_replicate&quot;
echo &quot;*** On first DB ***&quot;
curl -s &quot;<span class="nv">$DB1</span>/doc1?conflicts=true&quot;
echo &quot;*** On second DB ***&quot;
curl -s &quot;<span class="nv">$DB2</span>/doc1?conflicts=true&quot;
</pre></div>
</td></tr></table>

<h3 id="further-reading">Further reading</h3>
<ul>
<li><a href="http://blogs.23.nu/c0re/2009/12/running-a-couchdb-cluster-on-amazon-ec2/">Running a CouchDB cluster on Amazon EC2</a> explains how to do password protected Replication over the Internet.</li>
<li><a href="http://code.google.com/p/couchdb-python/source/browse/couchdb/tools/manual_replication.py"> manual_replication</a> is a script to trigger various replication scenarios.</li>
</ul>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>