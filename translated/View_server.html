<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - View_server</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>A simple introduction to the CouchDB view server.</p>
<h2 id="the-view-server">The View Server</h2>
<p>CouchDB delegates computation of <a class="internal" href="Views.html">Views</a> to external query servers. It communicates with them over standard input/output, using a very simple, line-based protocol. The default query server is written in Javascript, running via Mozilla !SpiderMonkey. You can use other languages by setting a MIME type in the <em>language</em> property of a design document or the Content-Type header of a temporary view. Design documents that do not specify a <em>language</em> property are assumed to be of type <em>javascript</em>, as are ad hoc queries that are <em>POST</em>ed to <em>_temp_view</em> without a <em>Content-Type</em> header.</p>
<p>To register query servers with CouchDB, add a line for each server to <em>local.ini</em>. The basic syntax is:</p>
<div class="codehilite"><pre><span class="k">[query_servers]</span>
<span class="na">python</span><span class="o">=</span><span class="s">/usr/bin/couchpy</span>
<span class="na">ruby</span><span class="o">=</span><span class="s">/wherever/couchobject/bin/couch_ruby_view_requestor</span>
</pre></div>


<h2 id="basic-api">Basic API</h2>
<p>This shows you how the view server implementation for your language should behave. If in doubt, look at the <em>share/server/main.js</em> file in your CouchDB source tree for reference.</p>
<p>CouchDB launches the view server and starts sending commands. The server responds according to its evaluation of the commands. There are only three commands the view server needs to understand.</p>
<h3 id="reset">reset</h3>
<p>This resets the state of the view server and makes it forget all previous input. If applicable, this is the point to run garbage collection.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;reset&quot;</span><span class="p">]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>The view server responds:</p>
<div class="codehilite"><pre><span class="n">true</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<h3 id="add_fun">add_fun</h3>
<p>When creating a view, the view server gets sent the view function for evaluation. The view server should parse/compile/evaluate the function he receives to make it callable later. If this fails, the view server returns an error. CouchDB might store several functions before sending in any actual documents.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;add_fun&quot;</span><span class="p">,</span> <span class="s">&quot;function(doc) { if(doc.score &gt; 50) emit(null, {&quot;</span><span class="n">player_name</span><span class="s">&quot;: doc.name}); }&quot;</span><span class="p">]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>When the view server can evaluate the function and make it callable, it returns:</p>
<div class="codehilite"><pre><span class="n">true</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>If not:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;some_error_code&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;error message&quot;</span><span class="p">}</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<h3 id="map_doc">map_doc</h3>
<p>When the view function is stored in the view server, CouchDB starts sending in all the documents in the database, one at a time. The view server calls the previously stored functions one after another with the document and stores its result. When all functions have been called, the result is returned as a JSON string.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;map_doc&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;8877AFF9789988EE&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;3-235256484&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;John Smith&quot;</span><span class="p">,</span><span class="s">&quot;score&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>If the function above is the only function stored, the views server answers:</p>
<div class="codehilite"><pre><span class="p">[[[</span><span class="n">null</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;player_name&quot;</span><span class="p">:</span><span class="s">&quot;John Smith&quot;</span><span class="p">}]]]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>That is, an array with the result for every function for the given document.</p>
<p>If a document is to be excluded from the View, the array should be empty.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;map_doc&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;9590AEB4585637FE&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;1-674684684&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;Jane Parker&quot;</span><span class="p">,</span><span class="s">&quot;score&quot;</span><span class="p">:</span> <span class="mi">43</span><span class="p">}]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>The views server answers:</p>
<div class="codehilite"><pre><span class="p">[[</span><span class="o">[]</span><span class="p">]]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<h3 id="reduce">reduce</h3>
<p>If the view has a <code>reduce</code> function defined, CouchDB will enter into the reduce phase. The view server will receive a list of reduce functions and some map results on which it can apply them. The map results are given in the form <code>[[key, id-of-doc], value]</code>.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;reduce&quot;</span><span class="p">,[</span><span class="s">&quot;function(k, v) { return sum(v); }&quot;</span><span class="p">],[[[</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;699b524273605d5d3e9d4fd0ff2cb272&quot;</span><span class="p">],</span><span class="mi">10</span><span class="p">],[[</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;c081d0f69c13d2ce2050d684c7ba2843&quot;</span><span class="p">],</span><span class="mi">20</span><span class="p">],[[</span><span class="n">null</span><span class="p">,</span><span class="s">&quot;foobar&quot;</span><span class="p">],</span><span class="mi">3</span><span class="p">]]]</span>
</pre></div>


<p>@@ Is there any guarantee on the ordering? The example appears unordered (null trailing)</p>
<p>The view-server answers:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">true</span><span class="p">,</span> <span class="p">[</span><span class="mi">33</span><span class="p">]]</span>
</pre></div>


<p>Note that even though the view server receives the map results in the form <code>[[key, id-of-doc], value]</code>, the function may receive them in a different form. For example, the JavaScript view-server applies functions on the list of keys and the list of values.</p>
<h3 id="rereduce">rereduce</h3>
<p>When building a view, CouchDB will apply the <code>reduce</code> step directly to the output of the map step and the <code>rereduce</code> step to the output of a previous <code>reduce</code> step.</p>
<p>CouchDB will send a list of values, with no keys or document ids, to the rereduce step.</p>
<p>CouchDB sends:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;rereduce&quot;</span><span class="p">,[</span><span class="s">&quot;function(k, v, r) { return sum(v); }&quot;</span><span class="p">],[</span><span class="mi">33</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">66</span><span class="p">]]</span>
</pre></div>


<p>The view-server answers:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">true</span><span class="p">,</span> <span class="p">[</span><span class="mi">154</span><span class="p">]]</span>
</pre></div>


<h3 id="log">log</h3>
<p>At any time, the view-server may send some information that will be saved in CouchDB's log file. This is done by sending a special object with just one field, <code>log</code>, on a separate line.</p>
<p>The view-server sends</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;log&quot;</span><span class="p">,</span> <span class="s">&quot;A kuku!&quot;</span><span class="p">]</span>
</pre></div>


<p>CouchDB answers nothing.</p>
<p>The following line will appear in <code>couch.log</code>, mutatis mutandum:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">Sun</span><span class="p">,</span> <span class="mi">22</span> <span class="n">Jun</span> <span class="mi">2008</span> <span class="mi">22</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">25</span> <span class="n">GMT</span><span class="p">]</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="s-Regexp">&lt;0.72.0&gt;</span><span class="p">]</span> <span class="n">Query</span> <span class="n">Server</span> <span class="n">Log</span> <span class="n">Message:</span> <span class="n">A</span> <span class="n">kuku</span><span class="o">!</span>
</pre></div>


<p>If you use the JavaScript view-server, you achieve this effect by calling the function <code>log</code> in your view. To do the same thing in ClCouch, call <code>logit</code>.</p>
<h2 id="implementations">Implementations</h2>
<ul>
<li><a href="http://svn.apache.org/repos/asf/couchdb/trunk/share/server/">JavaScript</a> (CouchDB native)</li>
<li><a href="http://common-lisp.net/cgi-bin/darcsweb/darcsweb.cgi?r=submarine-cl-couch;a=summary">Common Lisp</a></li>
<li><a href="http://jan.prima.de/~jan/plok/archives/93-CouchDb-Views-with-PHP.html">PHP</a></li>
<li><a href="http://theexciter.com/articles/couchdb-views-in-ruby-instead-of-javascript.html">Ruby</a> <a href="http://github.com/candlerb/couchdb_ruby_view">(fork)</a></li>
<li><a href="http://couchdb-python.googlecode.com/svn/trunk/couchdb/view.py">Python</a></li>
<li><a href="http://github.com/mmcdanie/erlview/tree/master">Erlang</a></li>
<li><a href="http://github.com/tashafa/clutch/">Clojure</a></li>
<li><a href="http://search.cpan.org/~hdp/CouchDB-View-0.003/lib/CouchDB/View/Server.pm">Perl</a></li>
<li><a href="http://chicken.wiki.br/eggref/4/couchdb-view-server">Chicken Scheme</a></li>
</ul>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>