<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Getting_started_with_PHP</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#getting-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>Getting started with PHP and the CouchDB API.</p>
<h2 id="couchdb-libraries">CouchDB Libraries</h2>
<ul>
<li>PHPillow: <a href="http://arbitracker.org/phpillow.html">http://arbitracker.org/phpillow.html</a>  * PHP Object_Freezer: <a href="https://github.com/sebastianbergmann/php-object-freezer/tree">https://github.com/sebastianbergmann/php-object-freezer/tree</a>  * PHP On Couch: <a href="http://github.com/dready92/PHP-on-Couch/tree/master">http://github.com/dready92/PHP-on-Couch/tree/master</a>  * PHP CouchDB Extension: <a href="http://www.topdog.za.net/php_couchdb_extension">http://www.topdog.za.net/php_couchdb_extension</a> </li>
</ul>
<h2 id="setup">Setup</h2>
<p>To get this example code running you need to install CouchDB on your system and have it running on port 5984. If you use a different machine or port, change the first two lines of code to your specific values.</p>
<h2 id="what-does-it-do">What Does it Do?</h2>
<p>This example first creates a !CouchSimple object that we're going to use for making connections to CouchDB on our machine, port 5984. Notice that this response is already encoded in JSON. CouchDB returns nothing but JSON wrapped in HTTP responses.</p>
<p>It then tries to make a simple GET request to the root of the data store.</p>
<p>We then look for a list of all databases in CouchDB and we find the one that ships with it, the <em>test_suite_db</em>. CouchDB has all sorts of special URLs for specific tasks. The <em>/_all_dbs</em> URL gives us a list of all the databases.</p>
<p>Next, we create a new database <em>test</em> using the HTTP method <em>PUT</em>. Creating databases is that easy.</p>
<p>Then we have a look all the documents in a database. To do so we send a GET request to the special URL <em>/test/_all_docs</em>. We get an empty list.</p>
<p>Time for action. We are now storing actual data, wrapped in JSON, in CouchDB. To do so, we make POST request to the test database and include a JSON object that has the special attribute <em>"_id": "123"</em>. This is unique identifier each document in CouchDB has. If you don't specify one here, CouchDB does it for you. In the response you see, that CouchDB then tells you what <em>_id</em> was created. There is also the <em>_rev</em> attribute which can be used to specify a document's revision, but this is beyond the scope of this introduction.</p>
<p>Assuming all goes well, we have another look at all the documents in the test database and 'lo and behold, our document is in.</p>
<p>We then proceed to getting it back out again with a simple GET request to <em>/test/123</em>. All documents you put into CouchDB can be retrieved like this. With their database and <em>_id</em> as the URL.</p>
<p>At last, we delete our database. The HTTP DELETE method does the job. You can also DELETE single documents in the same way.</p>
<div class="codehilite"><pre><span class="cp">&lt;?php</span>

 <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">;</span> 
 <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="m">5984</span><span class="p">;</span>

 <span class="nv">$couch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CouchSimple</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span> <span class="c1">// See if we can make a connection</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// response: string(46) &quot;{&quot;couchdb&quot;: &quot;Welcome&quot;, &quot;version&quot;: &quot;0.7.0a553&quot;}&quot;</span>

 <span class="c1">// Get a list of all databases in CouchDb </span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/_all_dbs&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(17) &quot;[&quot;test_suite_db&quot;]&quot;</span>

 <span class="c1">// Create a new database &quot;test&quot;</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;/test&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(12) &quot;{&quot;ok&quot;:true}&quot;</span>

 <span class="c1">// Get all documents in that database</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/test/_all_docs&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(27) &quot;{&quot;total_rows&quot;:0,&quot;rows&quot;:[]}&quot;</span>

 <span class="c1">// Create a new document in the database test with the id 123 and some data</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;/test/123&quot;</span><span class="p">,</span> <span class="s1">&#39;{&quot;_id&quot;:&quot;123&quot;,&quot;data&quot;:&quot;Foo&quot;}&#39;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(42) &quot;{&quot;ok&quot;:true,&quot;id&quot;:&quot;123&quot;,&quot;rev&quot;:&quot;2039697587&quot;}&quot;</span>

 <span class="c1">// Get all documents in test again, seing doc 123 there</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/test/_all_docs&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(91) &quot;{&quot;total_rows&quot;:1,&quot;offset&quot;:0,&quot;rows&quot;:[{&quot;id&quot;:&quot;123&quot;,&quot;key&quot;:&quot;123&quot;,&quot;value&quot;:{&quot;rev&quot;:&quot;2039697587&quot;}}]}&quot;</span>

 <span class="c1">// Get back document with the id 123</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/test/123&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(47) &quot;{&quot;_id&quot;:&quot;123&quot;,&quot;_rev&quot;:&quot;2039697587&quot;,&quot;data&quot;:&quot;Foo&quot;}&quot;</span>

 <span class="c1">// Delete our &quot;test&quot; database</span>
 <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$couch</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;/test/&quot;</span><span class="p">);</span> 
 <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$resp</span><span class="p">);</span> <span class="c1">// string(12) &quot;{&quot;ok&quot;:true}&quot;</span>

 <span class="k">class</span> <span class="nc">CouchSimple</span> <span class="p">{</span>
    <span class="k">function</span> <span class="nf">CouchSimple</span><span class="p">(</span><span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">foreach</span><span class="p">(</span><span class="nv">$options</span> <span class="k">AS</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$key</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
       <span class="p">}</span>
    <span class="p">}</span>

   <span class="k">function</span> <span class="nf">send</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$post_data</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$s</span> <span class="o">=</span> <span class="nb">fsockopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">port</span><span class="p">,</span> <span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">);</span> 
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$s</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">$errno</span><span class="s2">: </span><span class="si">$errstr</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span> 
         <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nv">$request</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">$method</span><span class="s2"> </span><span class="si">$url</span><span class="s2"> HTTP/1.0</span><span class="se">\r\n</span><span class="s2">Host: localhost</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="nv">$post_data</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$request</span> <span class="o">.=</span> <span class="s2">&quot;Content-Length: &quot;</span><span class="o">.</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$post_data</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">;</span> 
         <span class="nv">$request</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="si">$post_data</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
      <span class="p">}</span> 
      <span class="k">else</span> <span class="p">{</span>
         <span class="nv">$request</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span> 
      <span class="nv">$response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$s</span><span class="p">))</span> <span class="p">{</span>
         <span class="nv">$response</span> <span class="o">.=</span> <span class="nb">fgets</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headers</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span> 
      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<h2 id="a-couchdb-response-class">A CouchDB Response Class</h2>
<p>We'll use the following class as a structure for storing and handling responses to our HTTP requests to the DB.  Instances of this will store response components, namely the headers and body, in appropriately named properties.  Eventually we might want to do more error checking based on the headers, etc.  For this example, we'll be most interested in <em>CouchDBResponse::getBody()</em>.  It returns either the text of the response or the data structure derived from decoding the JSON response based on the method's only parameter, <em>$decode_json</em>.  Inside the <em>getBody</em> method, we call a static method <em>decode_json</em> that lives in our as-yet-unwritten <em>CouchDB</em> class.  We'll get to that soon enough, but all it really does in this example is wrap a call to the PHP json extension's <em>json_decode</em> function.</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">CouchDBResponse</span> <span class="p">{</span>

    <span class="n">private</span> <span class="nv">$raw_response</span> <span class="o">=</span> <span class="o">*</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="o">*</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$body</span> <span class="o">=</span> <span class="o">*</span><span class="p">;</span>

    <span class="n">function</span> <span class="n">_</span><span class="o">\</span><span class="n">_construct</span><span class="p">(</span><span class="nv">$response</span> <span class="o">=</span> <span class="o">*</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">raw_response</span> <span class="o">=</span> <span class="nv">$response</span><span class="p">;</span>
        <span class="n">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="s">&quot;\r\n\r\n&quot;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">getRawResponse</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">raw_response</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">getHeaders</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">getBody</span><span class="p">(</span><span class="nv">$decode_json</span> <span class="o">=</span> <span class="n">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$decode_json</span> <span class="p">?</span> <span class="nn">CouchDB::</span><span class="n">decode_json</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">)</span> <span class="p">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="a-couchdb-request-class">A CouchDB Request Class</h2>
<p>Now that we have a response class, we need something to organize our requests.  This class will 1) build request headers and assemble the request, 2) send the request and 3) give us the interesting part of the result.  Following <a class="internal" href="GettingStartedWithPhp.html">GettingStartedWithPhp</a>, we make our requests using <em>fsockopen</em>, which allows us to treat our connection to the CouchDB server as a file pointer.  When we execute the request, we pass the response on to a new <em>CouchDBRequest</em> object.</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">CouchDBRequest</span> <span class="p">{</span>

    <span class="n">static</span> <span class="nv">$VALID_HTTP_METHODS</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;PUT&#39;</span><span class="p">);</span>

    <span class="n">private</span> <span class="nv">$method</span> <span class="o">=</span> <span class="s">&#39;GET&#39;</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$url</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$data</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$sock</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="n">function</span> <span class="n">_</span><span class="o">\</span><span class="n">_construct</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span> <span class="o">=</span> <span class="mi">5984</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$method</span> <span class="o">=</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span> <span class="nv">$username</span> <span class="o">=</span> <span class="n">null</span><span class="p">,</span> <span class="nv">$password</span> <span class="o">=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$method</span> <span class="o">=</span> <span class="n">strtoupper</span><span class="p">(</span><span class="nv">$method</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nv">$port</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">url</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="nv">$method</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span> <span class="nn">self::</span><span class="nv">$VALID_HTTP_METHODS</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="k">new</span> <span class="n">CouchDBException</span><span class="p">(</span><span class="s">&#39;Invalid HTTP method: &#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">getRequest</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$req</span> <span class="o">=</span> <span class="s">&quot;{$this-&gt;method} {$this-&gt;url} HTTP/1.0\r\nHost: {$this-&gt;host}\r\n&quot;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span>
            <span class="nv">$req</span> <span class="o">.=</span> <span class="s">&#39;Authorization: Basic &#39;</span><span class="o">.</span><span class="n">base64_encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span><span class="o">.</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">)</span><span class="o">.</span><span class="s">&quot;\r\n&quot;</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$req</span> <span class="o">.=</span> <span class="s">&#39;Content-Length: &#39;</span><span class="o">.</span><span class="n">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="s">&quot;\r\n&quot;</span><span class="p">;</span>
            <span class="nv">$req</span> <span class="o">.=</span> <span class="s">&#39;Content-Type: application/json&#39;</span><span class="o">.</span><span class="s">&quot;\r\n\r\n&quot;</span><span class="p">;</span>
            <span class="nv">$req</span> <span class="o">.=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">.</span><span class="s">&quot;\r\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$req</span> <span class="o">.=</span> <span class="s">&quot;\r\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$req</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">function</span> <span class="nb">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">=</span> <span class="nv">@fsockopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nv">$err_num</span><span class="p">,</span> <span class="nv">$err_string</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="k">new</span> <span class="n">CouchDBException</span><span class="p">(</span><span class="s">&#39;Could not open connection to &#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">.</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">.</span><span class="s">&#39; (&#39;</span><span class="o">.</span><span class="nv">$err_string</span><span class="o">.</span><span class="s">&#39;)&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">function</span> <span class="n">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fclose</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">private</span> <span class="n">function</span> <span class="n">execute</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">getRequest</span><span class="p">());</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="o">*</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$response</span> <span class="o">.=</span> <span class="n">fgets</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CouchDBResponse</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="nb">send</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">getResponse</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="the-couchdb-class">The CouchDB Class</h2>
<p>The CouchDB class provides a <em>send</em> method for sending requests to the CouchDB server.  It uses the <em>CouchDBRequest</em> class above and returns a <em>CouchDBResponse</em> object.  This class also provides a method for fetching all documents in a database, using the <em>_all_docs'' built-in view.  I've also included a </em>get_item* method for fetching a document with its id.  Clearly, further abstraction for different types of queries, etc. should follow, but this is enough for us to get at the data in our database.</p>
<p>Supports HTTP Basic Authentication for the whole session - just provide either the username, password, or both when creating this class. The pair is then sent to the CouchDBRequest to be included in the header.</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">CouchDB</span> <span class="p">{</span>

    <span class="n">private</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="n">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="n">function</span> <span class="n">_</span><span class="o">\</span><span class="n">_construct</span><span class="p">(</span><span class="nv">$db</span><span class="p">,</span> <span class="nv">$host</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="nv">$port</span> <span class="o">=</span> <span class="mi">5984</span><span class="p">,</span> <span class="nv">$username</span> <span class="o">=</span> <span class="n">null</span><span class="p">,</span> <span class="nv">$password</span> <span class="o">=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="nv">$db</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="nv">$port</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">static</span> <span class="n">function</span> <span class="n">decode_json</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">json_decode</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">static</span> <span class="n">function</span> <span class="n">encode_json</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">json_encode</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="nb">send</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$method</span> <span class="o">=</span> <span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="nv">$data</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">.</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span> <span class="p">?</span> <span class="nv">$url</span> <span class="p">:</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="nv">$url</span><span class="p">);</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CouchDBRequest</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">username</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">password</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">get_all_docs</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&#39;/_all_docs&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">function</span> <span class="n">get_item</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nb">send</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="nv">$id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="using-our-couchdb-class">Using Our CouchDB Class</h2>
<p>The following is some code just playing around with our pastebin data, which we assume contains the fields title, body, created, and status.</p>
<div class="codehilite"><pre><span class="sr">//</span> <span class="n">we</span> <span class="n">get</span> <span class="n">a</span> <span class="k">new</span> <span class="n">CouchDB</span> <span class="n">object</span> <span class="n">that</span> <span class="n">will</span> <span class="k">use</span> <span class="n">the</span> <span class="s">&#39;pastebin&#39;</span> <span class="n">db</span>
<span class="nv">$couchdb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CouchDB</span><span class="p">(</span><span class="s">&#39;pastebin&#39;</span><span class="p">);</span>
<span class="n">try</span> <span class="p">{</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$couchdb</span><span class="o">-&gt;</span><span class="n">get_all_docs</span><span class="p">();</span>
<span class="p">}</span> <span class="n">catch</span><span class="p">(</span><span class="n">CouchDBException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">die</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="n">errorMessage</span><span class="p">()</span><span class="o">.</span><span class="s">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="sr">//</span> <span class="n">here</span> <span class="n">we</span> <span class="n">get</span> <span class="n">the</span> <span class="n">decoded</span> <span class="n">json</span> <span class="n">from</span> <span class="n">the</span> <span class="n">response</span>
<span class="nv">$all_docs</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="n">getBody</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>

<span class="sr">//</span> <span class="k">then</span> <span class="n">we</span> <span class="n">can</span> <span class="n">iterate</span> <span class="n">through</span> <span class="n">the</span> <span class="n">returned</span> <span class="n">rows</span> <span class="ow">and</span> <span class="n">fetch</span> <span class="nb">each</span> <span class="n">item</span> <span class="n">using</span> <span class="n">its</span> <span class="n">id</span><span class="o">.</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$all_docs</span><span class="o">-&gt;</span><span class="n">rows</span> <span class="n">as</span> <span class="nv">$r</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">print_r</span><span class="p">(</span><span class="nv">$couchdb</span><span class="o">-&gt;</span><span class="n">get_item</span><span class="p">(</span><span class="nv">$row</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="sr">//</span> <span class="k">if</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">find</span> <span class="n">only</span> <span class="n">pastebin</span> <span class="n">items</span> <span class="n">that</span> <span class="n">are</span> <span class="n">currently</span> <span class="n">published</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="k">do</span> <span class="n">a</span> <span class="n">little</span> <span class="n">more</span><span class="o">.</span>
<span class="sr">//</span> <span class="n">below</span><span class="p">,</span> <span class="n">we</span> <span class="n">create</span> <span class="n">a</span> <span class="n">view</span> <span class="n">using</span> <span class="n">a</span> <span class="n">javascript</span> <span class="n">function</span> <span class="n">passed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">post</span> <span class="n">data</span><span class="o">.</span>
<span class="nv">$map</span> <span class="o">=</span> <span class="o">&lt;&lt;&lt;</span><span class="n">MAP</span>
<span class="n">function</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">&#39;published&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">emit</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="p">{</span><span class="n">docTitle:</span> <span class="n">doc</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">docBody:</span> <span class="n">doc</span><span class="o">.</span><span class="n">body</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">MAP</span><span class="p">;</span>
<span class="nv">$view</span> <span class="o">=</span> <span class="s">&#39;{&quot;map&quot;:&quot;&#39;</span><span class="o">.</span><span class="nv">$map</span><span class="o">.</span><span class="s">&#39;&quot;}&#39;</span><span class="p">;</span>

<span class="sr">//</span> <span class="n">we</span> <span class="n">set</span> <span class="n">the</span> <span class="n">method</span> <span class="n">to</span> <span class="n">POST</span> <span class="ow">and</span> <span class="nb">send</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">couch</span> <span class="n">db</span><span class="s">&#39;s /_temp_view. the text of the view is passed as post data.</span>
<span class="s">// this javascript function will return documents whose &#39;</span><span class="n">status</span><span class="s">&#39; field contains &#39;</span><span class="n">published</span><span class="s">&#39;.</span>
<span class="s">// note that we set the content type to &#39;</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="s">&#39; for posts in our couchdb class.</span>
<span class="s">$view_result = $couchdb-&gt;send(&#39;</span><span class="o">/</span><span class="n">_temp_view</span><span class="s">&#39;, &#39;</span><span class="n">post</span><span class="err">&#39;</span><span class="p">,</span> <span class="nv">$view</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$view_result</span><span class="o">-&gt;</span><span class="n">getBody</span><span class="p">();</span>
</pre></div>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>