<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Document_Update_Handlers</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#getting-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <!-- ## page was renamed from Document Update Handlers -->
<!-- ## page was renamed from How_to_intercept_document_updates_and_perform_additional_server-side_processing -->

<h1 id="document-update-handlers">Document Update Handlers</h1>
<div class="toc">
<ul>
<li><a href="#document-update-handlers">Document Update Handlers</a><ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#implementation">Implementation</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#tbd">TBD</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="basics">Basics</h2>
<p>CouchDB (0.10 and up) has the ability to allow server-side updating of a document without the usual GET-modify-POST cycle, or server-side creation of a new document based on parameters sent by the user. This feature allows a range of use cases such as providing a server-side last modified timestamp, updating individual fields in a document without first getting the latest revision, etc.</p>
<p>It's important to note that and update handler doesn't need to have an entire document sent to it, as it will be passed the server's current version of the requested document. In fact, any parameters passed to an update function, other than the document ID, have to be handled manually by the update function itself.</p>
<h2 id="implementation">Implementation</h2>
<p>This functionality is implemented via document update handlers defined in a design doc. Specifically, in a design doc one defines an "updates" attribute that contains any number of document update handlers. The follow handlers should be self-explanatory as to what they accomplish. </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="codehilite"><pre><span class="p">{</span>
  <span class="nx">updates</span><span class="o">:</span> <span class="p">{</span>

    <span class="s2">&quot;hello&quot;</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">docId</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">[{</span>
            <span class="nx">_id</span> <span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">docId</span>
          <span class="p">},</span> <span class="s2">&quot;New World&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;Empty World&quot;</span><span class="p">];</span>          
      <span class="p">}</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">world</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">edited_by</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">userCtx</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="s2">&quot;hello doc&quot;</span><span class="p">];</span>
    <span class="p">},</span>

    <span class="s2">&quot;in-place&quot;</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">field</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">field</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;set &quot;</span><span class="o">+</span><span class="nx">field</span><span class="o">+</span><span class="s2">&quot; to &quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">message</span><span class="p">];</span>
    <span class="p">},</span>

    <span class="s2">&quot;bump-counter&quot;</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;bumped it!&lt;/h1&gt;&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">message</span><span class="p">];</span>
    <span class="p">},</span>

    <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">superFail</span><span class="p">.</span><span class="nx">badCrash</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="s2">&quot;xml&quot;</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XML</span><span class="p">(</span><span class="s1">&#39;&lt;xml&gt;&lt;/xml&gt;&#39;</span><span class="p">);</span>
      <span class="nx">xml</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">posted_xml</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XML</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="nx">doc</span><span class="p">.</span><span class="nx">via_xml</span> <span class="o">=</span> <span class="nx">posted_xml</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">resp</span> <span class="o">=</span>  <span class="p">{</span>
        <span class="s2">&quot;headers&quot;</span> <span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="s2">&quot;application/xml&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;body&quot;</span> <span class="o">:</span> <span class="nx">xml</span>
      <span class="p">};</span>

       <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">resp</span><span class="p">];</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The handler function takes the document and the http request as parameters. It returns a two-element array: the first element is the (updated) document, which is committed to the database. The second element is the response that will be sent back to the caller.</p>
<h2 id="usage">Usage</h2>
<p>To invoke a handler, one must "PUT" the document against the handler function itself (POST does not seem to be supported). Using the canonical document URL won't invoke any handlers.</p>
<p>For example, to invoke the "in-place" handler defined above, the URL to use is:</p>
<div class="codehilite"><pre><span class="n">http:</span><span class="sr">//</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">5984</span><span class="sr">/&lt;my_database&gt;/</span><span class="n">_design</span><span class="sr">/&lt;my_designdoc&gt;/</span><span class="n">_update</span><span class="sr">/in-place/</span><span class="s-Regexp">&lt;mydocId&gt;</span><span class="p">?</span><span class="n">field</span><span class="o">=</span><span class="n">title</span><span class="o">&amp;</span><span class="n">value</span><span class="o">=</span><span class="n">test</span>
</pre></div>


<p>This means that unlike document validators, the user's intent must be clear by calling this individual handler explicitly. In this sense, you should think about an <em>_update</em> handler as complementary to <em>_show</em> functions, not to <em>validate_doc_update</em> functions.</p>
<h2 id="tbd">TBD</h2>
<ul>
<li>Is POST supported, or only PUT?</li>
<li>Maybe we should support PATCH?</li>
<li>Must fields be sent as URL query parameters, or can they be sent in the request representation?</li>
</ul>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>