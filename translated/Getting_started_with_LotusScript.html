<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Getting_started_with_LotusScript</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <!-- ## page was renamed from Getting Started With LotusScript -->
<!-- ## page was renamed from GettingStartedLotusScript -->

<p>Getting started with !LotusScript and the CouchDB API.</p>
<p>This is an example of wrapper classes that use LS2J to send requests to a CouchDB server from !LotusScript. This could be useful to move data between Domino databases and CouchDB databases. The !LotusScript code roughly tracks the structure of the Ruby code.</p>
<h2 id="basic-api">Basic API</h2>
<div class="codehilite"><pre><span class="n">Option</span> <span class="n">Public</span>
<span class="n">Uselsx</span> <span class="s">&quot;*javacon&quot;</span>

<span class="n">Sub</span> <span class="n">Initialize</span>
<span class="nv">%REM</span>
<span class="n">LotusScript</span> <span class="n">LS2J</span> <span class="n">classes</span> <span class="k">for</span> <span class="n">CouchDb</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2006</span>  <span class="n">Alan</span> <span class="n">Bell</span> <span class="o">-</span> <span class="n">Dominux</span> <span class="n">Consulting</span>

<span class="n">This</span> <span class="n">program</span> <span class="n">is</span> <span class="n">free</span> <span class="n">software</span><span class="p">;</span> <span class="n">you</span> <span class="n">can</span> <span class="n">redistribute</span> <span class="n">it</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span>
<span class="n">modify</span> <span class="n">it</span> <span class="n">under</span> <span class="n">the</span> <span class="n">terms</span> <span class="n">of</span> <span class="n">the</span> <span class="n">GNU</span> <span class="n">General</span> <span class="n">Public</span> <span class="n">License</span>
<span class="n">as</span> <span class="n">published</span> <span class="n">by</span> <span class="n">the</span> <span class="n">Free</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">;</span> <span class="n">either</span> <span class="n">version</span> <span class="mi">2</span>
<span class="n">of</span> <span class="n">the</span> <span class="n">License</span><span class="p">,</span> <span class="ow">or</span> <span class="p">(</span><span class="n">at</span> <span class="n">your</span> <span class="n">option</span><span class="p">)</span> <span class="n">any</span> <span class="n">later</span> <span class="n">version</span><span class="o">.</span>

<span class="n">This</span> <span class="n">program</span> <span class="n">is</span> <span class="n">distributed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">hope</span> <span class="n">that</span> <span class="n">it</span> <span class="n">will</span> <span class="n">be</span> <span class="n">useful</span><span class="p">,</span>
<span class="n">but</span> <span class="n">WITHOUT</span> <span class="n">ANY</span> <span class="n">WARRANTY</span><span class="p">;</span> <span class="n">without</span> <span class="n">even</span> <span class="n">the</span> <span class="n">implied</span> <span class="n">warranty</span> <span class="n">of</span>
<span class="n">MERCHANTABILITY</span> <span class="ow">or</span> <span class="n">FITNESS</span> <span class="n">FOR</span> <span class="n">A</span> <span class="n">PARTICULAR</span> <span class="n">PURPOSE</span><span class="o">.</span>  <span class="n">See</span> <span class="n">the</span>
<span class="n">GNU</span> <span class="n">General</span> <span class="n">Public</span> <span class="n">License</span> <span class="k">for</span> <span class="n">more</span> <span class="n">details</span><span class="o">.</span>

<span class="n">You</span> <span class="n">should</span> <span class="n">have</span> <span class="n">received</span> <span class="n">a</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">the</span> <span class="n">GNU</span> <span class="n">General</span> <span class="n">Public</span> <span class="n">License</span>
<span class="n">along</span> <span class="n">with</span> <span class="n">this</span> <span class="n">program</span><span class="p">;</span> <span class="k">if</span> <span class="ow">not</span><span class="p">,</span> <span class="nb">write</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Free</span> <span class="n">Software</span>
<span class="n">Foundation</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span><span class="p">,</span> <span class="mi">51</span> <span class="n">Franklin</span> <span class="n">Street</span><span class="p">,</span> <span class="n">Fifth</span> <span class="n">Floor</span><span class="p">,</span> <span class="n">Boston</span><span class="p">,</span> <span class="n">MA</span>  <span class="mo">02110</span><span class="o">-</span><span class="mi">1301</span><span class="p">,</span> <span class="n">USA</span><span class="o">.</span>
<span class="nv">%ENDREM</span>
  <span class="s">&#39;right now this just implements the basic database operations</span>
<span class="s">  &#39;</span><span class="n">feel</span> <span class="n">free</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">bugs</span> <span class="ow">and</span> <span class="n">add</span> <span class="n">functionailty</span> <span class="n">to</span> <span class="n">it</span> <span class="n">in</span> <span class="n">the</span> <span class="n">Wiki</span>
  <span class="s">&#39;there is a total lack of releasing of objects right now so it will leak memory like a sieve</span>
<span class="s">  &#39;</span><span class="n">error</span> <span class="n">handling</span> <span class="n">would</span> <span class="n">be</span> <span class="n">nice</span> <span class="n">too</span><span class="o">.</span>
  <span class="n">Dim</span> <span class="n">cserver</span> <span class="n">As</span> <span class="n">couchserver</span>
  <span class="n">Set</span> <span class="n">cserver</span><span class="o">=</span><span class="n">New</span> <span class="n">couchserver</span><span class="p">(</span><span class="s">&quot;http://localhost&quot;</span><span class="p">,</span><span class="s">&quot;5984&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
  <span class="s">&#39;create a database</span>
<span class="s">  Call cserver.put(&quot;/ls2couch/&quot;,&quot;&quot;)</span>
<span class="s">  &#39;</span><span class="n">create</span> <span class="n">a</span> <span class="n">document</span>
  <span class="n">Call</span> <span class="n">cserver</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;/ls2couch/document_id&quot;</span><span class="p">,</span> <span class="o">|</span><span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;comment&quot;</span><span class="p">,</span><span class="s">&quot;body&quot;</span><span class="p">:</span><span class="s">&quot;First Post!&quot;</span><span class="p">}</span><span class="o">|</span><span class="p">)</span>
  <span class="s">&#39;retrieve the document</span>
<span class="s">  Print cserver.cget(&quot;/ls2couch/document_id&quot;)</span>
<span class="s">  &#39;</span><span class="nb">delete</span> <span class="n">the</span> <span class="n">database</span>
  <span class="n">Call</span> <span class="n">cserver</span><span class="o">.</span><span class="n">del</span><span class="p">(</span><span class="s">&quot;/ls2couch/&quot;</span><span class="p">)</span>
<span class="n">End</span> <span class="n">Sub</span>

<span class="n">Class</span> <span class="n">couchserver</span>
  <span class="n">Private</span> <span class="n">host</span> <span class="n">As</span> <span class="n">String</span>
  <span class="n">Private</span> <span class="n">port</span> <span class="n">As</span> <span class="n">String</span>
  <span class="n">Private</span> <span class="n">options</span> <span class="n">As</span> <span class="n">String</span>
  <span class="n">Private</span> <span class="n">proxyserver</span> <span class="n">As</span> <span class="n">String</span>
  <span class="n">Private</span> <span class="n">proxyport</span> <span class="n">As</span> <span class="n">String</span>
  <span class="n">Private</span> <span class="n">jses</span> <span class="n">As</span> <span class="n">JAVASESSION</span>
  <span class="n">Private</span> <span class="n">jclass</span> <span class="n">As</span> <span class="n">JAVACLASS</span>
  <span class="n">Private</span> <span class="n">jurl</span> <span class="n">As</span> <span class="n">JAVAOBJECT</span>
  <span class="n">Private</span> <span class="n">jcon</span> <span class="n">As</span> <span class="n">JAVAOBJECT</span>
  <span class="n">Sub</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">port</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">options</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
    <span class="s">&#39;this corresponds to the initialise method in the Ruby classes</span>
<span class="s">    Me.host=host</span>
<span class="s">    Me.port=port</span>
<span class="s">    Me.options=options</span>
<span class="s">    Set Me.jses=New JAVASESSION()</span>
<span class="s">  End Sub</span>

<span class="s">  Sub setproxy(proxyserver As String,proxyport As String)</span>
<span class="s">    &#39;</span><span class="n">this</span> <span class="n">should</span> <span class="k">do</span> <span class="n">something</span><span class="o">.</span> <span class="n">At</span> <span class="n">the</span> <span class="n">moment</span> <span class="n">it</span> <span class="n">does</span> <span class="ow">not</span><span class="o">.</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">proxyserver</span><span class="o">=</span><span class="n">proxyserver</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">proxyport</span><span class="o">=</span><span class="n">proxyport</span>
  <span class="n">End</span> <span class="n">Sub</span>

  <span class="n">Sub</span> <span class="n">del</span><span class="p">(</span><span class="n">uri</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
  <span class="s">&#39;this corresponds to the delete method in the Ruby classes</span>
<span class="s">    Set Me.jclass=jses.GetClass(&quot;java/net/URL&quot;)</span>
<span class="s">    Set Me.jurl=Me.jclass.CreateObject(&quot;(Ljava/lang/String;)V&quot;,host+&quot;:&quot;+port+uri)</span>
<span class="s">    Set jcon=jurl.openConnection()</span>
<span class="s">    Me.jcon.setRequestMethod(&quot;DELETE&quot;)</span>
<span class="s">    Call Me.jcon.connect()</span>
<span class="s">    Set ist=jcon.getInputStream()&#39;</span><span class="n">oddly</span> <span class="n">enough</span> <span class="n">java</span> <span class="n">doesn</span><span class="s">&#39;t do anything with a URL until you read from it.</span>
<span class="s">    Call ist.close()</span>
<span class="s">  End Sub</span>

<span class="s">  Function cget(uri As String) As String</span>
<span class="s">    &#39;</span><span class="n">this</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="n">get</span> <span class="n">class</span> <span class="n">in</span> <span class="n">Ruby</span><span class="o">.</span> <span class="s">&quot;get&quot;</span> <span class="n">is</span> <span class="n">a</span> <span class="n">reserved</span> <span class="n">word</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/net/URL&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jurl</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">jcon</span><span class="o">=</span><span class="n">jurl</span><span class="o">.</span><span class="n">openConnection</span><span class="p">()</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setRequestMethod</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="nb">connect</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/io/InputStreamReader&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">ireader</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/io/InputStream;)V&quot;</span><span class="p">,</span><span class="n">ist</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/io/BufferedReader&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">bReader</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/io/Reader;)V&quot;</span><span class="p">,</span><span class="n">ireader</span><span class="p">)</span>
    <span class="n">cget</span><span class="o">=</span><span class="n">bReader</span><span class="o">.</span><span class="n">readLine</span><span class="p">()</span>
    <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
  <span class="n">End</span> <span class="n">Function</span>

  <span class="n">Sub</span> <span class="n">put</span> <span class="p">(</span><span class="n">uri</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">xml</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/net/URL&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jurl</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">jcon</span><span class="o">=</span><span class="n">jurl</span><span class="o">.</span><span class="n">openConnection</span><span class="p">()</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setRequestMethod</span><span class="p">(</span><span class="s">&quot;PUT&quot;</span><span class="p">)</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setdooutput</span><span class="p">(</span><span class="n">True</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="nb">connect</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">ost</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/io/OutputStreamWriter&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">owriter</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/io/OutputStream;)V&quot;</span><span class="p">,</span><span class="n">ost</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">owriter</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Len</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
    <span class="n">Call</span> <span class="n">owriter</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
    <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
  <span class="n">End</span> <span class="n">Sub</span>

  <span class="n">Sub</span> <span class="n">post</span><span class="p">(</span><span class="n">uri</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">xml</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/net/URL&quot;</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jurl</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">Set</span> <span class="n">jcon</span><span class="o">=</span><span class="n">jurl</span><span class="o">.</span><span class="n">openConnection</span><span class="p">()</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setRequestMethod</span><span class="p">(</span><span class="s">&quot;PUT&quot;</span><span class="p">)</span>
    <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setdooutput</span><span class="p">(</span><span class="n">True</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="nb">connect</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">ost</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span>
    <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
    <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
  <span class="n">End</span> <span class="n">Sub</span>

<span class="n">End</span> <span class="n">Class</span>
</pre></div>


<h2 id="advanced-api">Advanced API</h2>
<p>This !LotusScript API for couch is designed to be familiar to !LotusScript developers. It wraps up all the communication with the CouchDB server, all the JSON code and looks quite a lot like dealing with documents in a domino database. This is very much a work in progress.</p>
<p>To copy a Notes database to a CouchDB database you might use the following code in an agent:</p>
<div class="codehilite"><pre><span class="n">Sub</span> <span class="n">Initialize</span>
  <span class="n">Dim</span> <span class="n">doc</span> <span class="n">As</span> <span class="n">couchdoc</span>
  <span class="n">Dim</span> <span class="n">ses</span> <span class="n">As</span> <span class="n">New</span> <span class="n">NotesSession</span>
  <span class="n">Dim</span> <span class="n">db</span> <span class="n">As</span> <span class="n">notesdatabase</span>
  <span class="n">Set</span> <span class="n">db</span><span class="o">=</span><span class="n">ses</span><span class="o">.</span><span class="n">currentdatabase</span>
  <span class="n">Dim</span> <span class="n">cserver</span> <span class="n">As</span> <span class="n">couchserver</span>
  <span class="n">Set</span> <span class="n">cserver</span><span class="o">=</span><span class="n">New</span> <span class="n">couchserver</span><span class="p">(</span><span class="s">&quot;http://localhost&quot;</span><span class="p">,</span><span class="s">&quot;5984&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="err">&#39;</span><span class="n">replace</span> <span class="n">with</span> <span class="n">your</span> <span class="n">server</span> <span class="n">location</span>
  <span class="n">Set</span> <span class="n">cdb</span><span class="o">=</span><span class="n">New</span> <span class="n">couchdb</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">cserver</span><span class="p">)</span>
  <span class="n">If</span> <span class="n">Not</span> <span class="n">cdb</span><span class="o">.</span><span class="nb">exists</span> <span class="n">Then</span>
    <span class="n">cdb</span><span class="o">.</span><span class="n">create</span>
  <span class="n">End</span> <span class="n">If</span>
  <span class="n">Dim</span> <span class="n">ndoc</span> <span class="n">As</span> <span class="n">NotesDocument</span>
  <span class="n">Dim</span> <span class="n">dbdocs</span> <span class="n">As</span> <span class="n">notesdocumentcollection</span>
  <span class="n">Set</span> <span class="n">dbdocs</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">alldocuments</span>
  <span class="n">Set</span> <span class="n">ndoc</span><span class="o">=</span><span class="n">dbdocs</span><span class="o">.</span><span class="n">GetFirstDocument</span>
  <span class="n">While</span> <span class="n">Not</span> <span class="n">ndoc</span> <span class="n">Is</span> <span class="n">Nothing</span>
    <span class="n">Set</span> <span class="n">doc</span><span class="o">=</span><span class="n">cdb</span><span class="o">.</span><span class="n">createdocument</span><span class="p">(</span><span class="n">ndoc</span><span class="o">.</span><span class="n">UniversalID</span><span class="p">)</span>
    <span class="n">Forall</span> <span class="n">i</span> <span class="n">In</span> <span class="n">ndoc</span><span class="o">.</span><span class="n">Items</span>
      <span class="n">Call</span> <span class="n">doc</span><span class="o">.</span><span class="n">additem</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">End</span> <span class="n">Forall</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">save</span>
    <span class="n">Set</span> <span class="n">ndoc</span><span class="o">=</span><span class="n">dbdocs</span><span class="o">.</span><span class="n">GetNextDocument</span><span class="p">(</span><span class="n">ndoc</span><span class="p">)</span>
  <span class="n">Wend</span>
<span class="n">End</span> <span class="n">Sub</span>
</pre></div>


<p>Copy the code below into the declarations section of the agent:</p>
<div class="codehilite"><pre> <span class="n">Class</span> <span class="n">couchserver</span>
 <span class="n">Private</span> <span class="n">host</span> <span class="n">As</span> <span class="n">String</span>
 <span class="n">Private</span> <span class="n">port</span> <span class="n">As</span> <span class="n">String</span>
 <span class="n">Private</span> <span class="n">options</span> <span class="n">As</span> <span class="n">String</span>
 <span class="n">Private</span> <span class="n">proxyserver</span> <span class="n">As</span> <span class="n">String</span>
 <span class="n">Private</span> <span class="n">proxyport</span> <span class="n">As</span> <span class="n">String</span>
 <span class="n">Private</span> <span class="n">jses</span> <span class="n">As</span> <span class="n">JAVASESSION</span>
 <span class="n">Private</span> <span class="n">jclass</span> <span class="n">As</span> <span class="n">JAVACLASS</span>
 <span class="n">Private</span> <span class="n">jurl</span> <span class="n">As</span> <span class="n">JAVAOBJECT</span>
 <span class="n">Private</span> <span class="n">jcon</span> <span class="n">As</span> <span class="n">JAVAOBJECT</span>
 <span class="n">Sub</span> <span class="k">new</span><span class="p">(</span><span class="n">host</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">port</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">options</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
      <span class="s">&#39;this corresponds to the initialise method in the Ruby classes</span>
<span class="s">   &#39;</span><span class="n">basically</span> <span class="n">creates</span> <span class="n">a</span> <span class="k">new</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">host</span><span class="o">=</span><span class="n">host</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">port</span><span class="o">=</span><span class="n">port</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">options</span><span class="o">=</span><span class="n">options</span>
   <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jses</span><span class="o">=</span><span class="n">New</span> <span class="n">JAVASESSION</span><span class="p">()</span>
 <span class="n">End</span> <span class="n">Sub</span>

 <span class="n">Sub</span> <span class="n">setproxy</span><span class="p">(</span><span class="n">proxyserver</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">proxyport</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
      <span class="s">&#39;this should do something. At the moment it does not.</span>
<span class="s">   Me.proxyserver=proxyserver</span>
<span class="s">   Me.proxyport=proxyport</span>
<span class="s"> End Sub</span>

<span class="s"> Sub del(uri As String)</span>
<span class="s">      &#39;</span><span class="n">this</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">delete</span> <span class="n">method</span> <span class="n">in</span> <span class="n">the</span> <span class="n">Ruby</span> <span class="n">classes</span>
   <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/net/URL&quot;</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jurl</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="n">uri</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">jcon</span><span class="o">=</span><span class="n">jurl</span><span class="o">.</span><span class="n">openConnection</span><span class="p">()</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setRequestMethod</span><span class="p">(</span><span class="s">&quot;DELETE&quot;</span><span class="p">)</span>
   <span class="n">Call</span> <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="nb">connect</span><span class="p">()</span>
   <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
   <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
 <span class="n">End</span> <span class="n">Sub</span>

 <span class="n">Function</span> <span class="n">cget</span><span class="p">(</span><span class="n">uri</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span> <span class="n">As</span> <span class="n">String</span>
      <span class="s">&#39;this corresponds to the get class in Ruby. &quot;get&quot; is a reserved word</span>
<span class="s">   Set Me.jclass=jses.GetClass(&quot;java/net/URL&quot;)</span>
<span class="s">   Set Me.jurl=Me.jclass.CreateObject(&quot;(Ljava/lang/String;)V&quot;,host+&quot;:&quot;+port+uri)</span>
<span class="s">   Set jcon=jurl.openConnection()</span>
<span class="s">   Me.jcon.setRequestMethod(&quot;GET&quot;)</span>
<span class="s">   Call Me.jcon.connect()</span>
<span class="s">   On Error Resume Next</span>
<span class="s">   Set ist=jcon.getInputStream()&#39;</span><span class="n">oddly</span> <span class="n">enough</span> <span class="n">java</span> <span class="n">doesn</span><span class="s">&#39;t do anything with a URL until you read from it.</span>
<span class="s">   Set Me.jclass=jses.GetClass(&quot;java/io/InputStreamReader&quot;)</span>

<span class="s">   Set ireader=Me.jclass.CreateObject(&quot;(Ljava/io/InputStream;)V&quot;,ist)</span>
<span class="s">   Set Me.jclass=jses.GetClass(&quot;java/io/BufferedReader&quot;)</span>
<span class="s">   Set bReader=Me.jclass.CreateObject(&quot;(Ljava/io/Reader;)V&quot;,ireader)</span>
<span class="s">   cget=bReader.readLine()</span>
<span class="s">   Call ist.close()</span>
<span class="s"> End Function</span>

<span class="s"> Sub put (uri As String,xml As String)</span>
<span class="s">   Set Me.jclass=jses.GetClass(&quot;java/net/URL&quot;)</span>
<span class="s">   Set Me.jurl=Me.jclass.CreateObject(&quot;(Ljava/lang/String;)V&quot;,host+&quot;:&quot;+port+uri)</span>
<span class="s">   Set jcon=jurl.openConnection()</span>
<span class="s">   Me.jcon.setRequestMethod(&quot;PUT&quot;)</span>
<span class="s">   Me.jcon.setdooutput(True)</span>
<span class="s">   Call Me.jcon.connect()</span>
<span class="s">   Set ost=jcon.getOutputStream()</span>
<span class="s">   Set Me.jclass=jses.GetClass(&quot;java/io/OutputStreamWriter&quot;)</span>
<span class="s">   &#39;</span><span class="n">Set</span> <span class="n">owriter</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/io/OutputStream;)V&quot;</span><span class="p">,</span><span class="n">ost</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">owriter</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/io/OutputStream;Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">ost</span><span class="p">,</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>
   <span class="n">Call</span> <span class="n">owriter</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Len</span><span class="p">(</span><span class="n">xml</span><span class="p">))</span>
   <span class="n">Call</span> <span class="n">owriter</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
   <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
   <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
   <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
   <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
 <span class="n">End</span> <span class="n">Sub</span>

 <span class="n">Sub</span> <span class="n">post</span><span class="p">(</span><span class="n">uri</span> <span class="n">As</span> <span class="n">String</span><span class="p">,</span><span class="n">xml</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">=</span><span class="n">jses</span><span class="o">.</span><span class="n">GetClass</span><span class="p">(</span><span class="s">&quot;java/net/URL&quot;</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">Me</span><span class="o">.</span><span class="n">jurl</span><span class="o">=</span><span class="n">Me</span><span class="o">.</span><span class="n">jclass</span><span class="o">.</span><span class="n">CreateObject</span><span class="p">(</span><span class="s">&quot;(Ljava/lang/String;)V&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">port</span><span class="o">+</span><span class="n">uri</span><span class="p">)</span>
   <span class="n">Set</span> <span class="n">jcon</span><span class="o">=</span><span class="n">jurl</span><span class="o">.</span><span class="n">openConnection</span><span class="p">()</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setRequestMet7hod</span><span class="p">(</span><span class="s">&quot;PUT&quot;</span><span class="p">)</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="n">setdooutput</span><span class="p">(</span><span class="n">True</span><span class="p">)</span>
   <span class="n">Call</span> <span class="n">Me</span><span class="o">.</span><span class="n">jcon</span><span class="o">.</span><span class="nb">connect</span><span class="p">()</span>
   <span class="n">Set</span> <span class="n">ost</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getOutputStream</span><span class="p">()</span>
   <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="nb">write</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
   <span class="n">Call</span> <span class="n">ost</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
   <span class="n">Set</span> <span class="n">ist</span><span class="o">=</span><span class="n">jcon</span><span class="o">.</span><span class="n">getInputStream</span><span class="p">()</span><span class="s">&#39;oddly enough java doesn&#39;</span><span class="n">t</span> <span class="k">do</span> <span class="n">anything</span> <span class="n">with</span> <span class="n">a</span> <span class="n">URL</span> <span class="k">until</span> <span class="n">you</span> <span class="nb">read</span> <span class="n">from</span> <span class="n">it</span><span class="o">.</span>
   <span class="n">Call</span> <span class="n">ist</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
 <span class="n">End</span> <span class="n">Sub</span>

 <span class="n">End</span> <span class="n">Class</span>

 <span class="n">Class</span> <span class="n">couchdb</span>
 <span class="s">&#39;this represents a database on the couchdb server</span>
<span class="s"> Public parentserver As couchserver</span>
<span class="s"> Public name As String</span>

<span class="s"> Sub new(dbname As String,server As couchserver)</span>
<span class="s">   Me.name=dbname</span>
<span class="s">   Set Me.parentserver=server</span>
<span class="s">   &#39;</span><span class="n">well</span> <span class="n">this</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">create</span> <span class="n">a</span> <span class="k">new</span> <span class="n">database</span><span class="p">,</span> <span class="n">just</span> <span class="n">initialises</span> <span class="n">the</span> <span class="n">class</span> <span class="ow">and</span> <span class="n">connects</span> <span class="n">it</span> <span class="n">to</span> <span class="n">a</span> <span class="n">database</span>
   <span class="s">&#39;the database might not exist</span>
<span class="s"> End Sub</span>

<span class="s"> Function exists As Boolean</span>
<span class="s">   &#39;</span><span class="n">tests</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">server</span> <span class="n">already</span> <span class="n">contains</span> <span class="n">a</span> <span class="n">database</span> <span class="n">with</span> <span class="n">this</span> <span class="n">name</span>
   <span class="nb">exists</span><span class="o">=</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">&lt;&gt;</span><span class="n">parentserver</span><span class="o">.</span><span class="n">cget</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Me</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
 <span class="n">End</span> <span class="n">Function</span>

 <span class="n">Sub</span> <span class="n">create</span>
   <span class="n">Call</span> <span class="n">parentserver</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Me</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
 <span class="n">End</span> <span class="n">Sub</span>

 <span class="n">Function</span> <span class="n">createdocument</span><span class="p">(</span><span class="n">id</span> <span class="n">As</span> <span class="n">String</span><span class="p">)</span> <span class="n">As</span> <span class="n">couchdoc</span>
   <span class="s">&#39;this does not create a document on the couchdb server until the document is saved</span>
<span class="s">   &#39;</span><span class="n">it</span> <span class="n">might</span> <span class="n">check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">id</span> <span class="n">has</span> <span class="n">already</span> <span class="n">been</span> <span class="n">used</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">that</span> <span class="n">document</span>
   <span class="s">&#39;it might create an ID of some kind if one is not provided</span>
<span class="s">   Set createdocument=New couchdoc(Me,id)</span>
<span class="s"> End Function</span>

<span class="s"> End Class</span>

<span class="s"> Class couchitem</span>
<span class="s"> Public parentdoc As couchdoc</span>
<span class="s"> &#39;</span><span class="n">represents</span> <span class="n">one</span> <span class="n">field</span> <span class="n">on</span> <span class="n">a</span> <span class="n">couchdb</span> <span class="n">document</span>
 <span class="n">Public</span> <span class="n">value</span> <span class="n">As</span> <span class="n">Variant</span>
 <span class="s">&#39;does an item know it&#39;</span><span class="n">s</span> <span class="n">own</span> <span class="n">name</span><span class="p">?</span> <span class="ow">not</span> <span class="n">sure</span><span class="o">.</span>
 <span class="n">Sub</span> <span class="k">new</span><span class="p">(</span><span class="n">value</span> <span class="n">As</span> <span class="n">Variant</span><span class="p">)</span>
   <span class="n">Me</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">value</span>
 <span class="n">End</span> <span class="n">Sub</span>
 <span class="n">Function</span> <span class="n">json</span> <span class="n">As</span> <span class="n">String</span>
   <span class="n">json</span><span class="o">=|</span><span class="s">&quot;|+Replace(Me.value,|&quot;</span><span class="o">|</span><span class="p">,</span><span class="o">|\</span><span class="s">&quot;|)+|&quot;</span><span class="o">|</span><span class="err">&#39;</span><span class="n">escaping</span> <span class="n">out</span> <span class="n">double</span> <span class="n">quotes</span>
 <span class="n">End</span> <span class="n">Function</span>
 <span class="n">End</span> <span class="n">Class</span>
</pre></div>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>