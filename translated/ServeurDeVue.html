<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - ServeurDeVue</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#getting-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <!-- #language fr -->

<p>Ce document constitue une simple introduction aux serveurs de vues de CouchDB.</p>
<h2 id="le-serveur-de-vue">Le serveur de vue</h2>
<p>CouchDB délègue le calcul des <a class="internal" href="Vues.html">Vues</a> à des serveurs de requêtes externes. Il communique avec eux à travers l'entrée/sortie standard via un ensemble de lignes. Le serveur de requêtes par défaut est en en Javascript, fonctionnant avec Mozilla !SpiderMonkey. Il est possible d'utiliser d'autres languages en modifiant la propriété <em>language</em> dans le fichier <em>couch.ini</em>. Si la propriété <em>language</em> n'est pas renseignée, Javascript est utilisé par défaut.</p>
<p>Pour enregistrer un serveur de requête auprès de CouchDB, il faut ajouter une ligne pour chaque serveur dans <em>couch.ini</em>. La syntaxe est :</p>
<div class="codehilite"><pre><span class="k">[Couch Query Servers]</span>

<span class="na">javascript</span><span class="o">=</span><span class="s">/usr/local/bin/couchjs -f /usr/local/share/couchdb/server/main.js</span>
<span class="na">ruby</span><span class="o">=</span><span class="s">/wherever/couchobject/bin/couch_ruby_view_requestor</span>
</pre></div>


<h2 id="api">API</h2>
<p>Ce document explique comment doit se comporter un serveur de vues. En cas de doute, référez vous au fichier <em>share/server/main.js</em> que vous pouvez trouver dans les sources de CouchDB.</p>
<p>CouchDB lance le serveur de vue et lui envoie des commandes. Le serveur lui répond en fonction de son évaluation de la commande. Il ya seulement 3 commandes que le serveur de vue a besoin de comprendre.</p>
<h3 id="reset-reinitialisation">reset (réinitialisation)</h3>
<p>Elle réinitialise le serveur de vue et lui fait supprimer toutes les entrées précedentes. Le cas échéant, le ramasse-miette (garbage collector) peut être lançé.</p>
<p>CouchDB envoie :</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;reset&quot;</span><span class="p">]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>Le serveur de vue répond :</p>
<div class="codehilite"><pre><span class="n">true</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<h3 id="add_fun-ajout-dune-fonction">add_fun (ajout d'une fonction)</h3>
<p>Lors de la création d'une vue, le serveur de vue reçoit la fonction de vue à évaluer. Le serveur de vue doit alors analyser/compiler/évaluer (selon le langage) la fonction qu'il reçoit et la rendre appelable depuis CouchDB. Si cela échoue, le serveur de vue retourne une erreur. CouchDB peut parfois stocker plusieurs fonctions avant d'envoyer des documents.</p>
<p>CouchDB envoie :</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;add_fun&quot;</span><span class="p">,</span> <span class="s">&quot;function(doc) { map(null, doc); }&quot;</span><span class="p">]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>lorsque le serveur de vues peut évaluer la fonction et la rendre appelable, il retourne :</p>
<div class="codehilite"><pre><span class="n">true</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>Sinon, un message d'erreur :</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span> <span class="s">&quot;some_error_code&quot;</span><span class="p">,</span> <span class="s">&quot;reason&quot;</span><span class="p">:</span> <span class="s">&quot;error message&quot;</span><span class="p">}</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<h3 id="map_doc-association">map_doc (association)</h3>
<p>Lorsque la fonction est enregistrée dans le serveur de vue, CouchDB commence à lui envoyer tous les documents un par un. Le serveur de vue applique les fonctions précedemment enregistrées l'une après l'autre sur le document et enregistre le résultat. Lorsque toutes les fonctions ont été appelées, le résultat est retourné sous forme d'une chaine de caractères JSON.</p>
<p>CouchDB envoie :</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;map_doc&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;8877AFF9789988EE&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="mi">46874684684</span><span class="p">,</span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="s">&quot;value&quot;</span><span class="p">,</span><span class="s">&quot;otherfield&quot;</span><span class="p">:</span><span class="s">&quot;othervalue&quot;</span><span class="p">}]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>Si la fonction définie ci-dessus est la seule enregistrée, le serveur de vue répond :</p>
<div class="codehilite"><pre><span class="p">[[[</span><span class="n">null</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;8877AFF9789988EE&quot;</span><span class="p">,</span> <span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="mi">46874684684</span><span class="p">,</span> <span class="s">&quot;field&quot;</span><span class="p">:</span><span class="s">&quot;value&quot;</span><span class="p">,</span> <span class="s">&quot;otherfield&quot;</span><span class="p">:</span><span class="s">&quot;othervalue&quot;</span><span class="p">}]]]</span><span class="o">\</span><span class="n">n</span>
</pre></div>


<p>C'est un tableau avec le résultat de chaque fonction sur le document. Si un document est exclu de la vue, le tableau doit être vide.</p>
<h3 id="reduce-reduction">reduce (réduction)</h3>
<p>Si la vue a une fonction <code>reduce</code> de définie, CouchDB entre dans la phase de réduction. Le serveur reçoit une liste des fonctions reduce et les résultats d'association (map) sur lesquels ils doit les appliquer. Les résultats d'association sont donnés sous la forme <code>[[key, id-of-doc], value]</code>.</p>
<p>CouchDB envoie :</p>
<div class="codehilite"><pre><span class="p">[</span><span class="s">&quot;reduce&quot;</span><span class="p">,[</span><span class="s">&quot;function(k, v) { return sum(v); }&quot;</span><span class="p">],[[[</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;699b524273605d5d3e9d4fd0ff2cb272&quot;</span><span class="p">],</span><span class="mi">10</span><span class="p">],[[</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;c081d0f69c13d2ce2050d684c7ba2843&quot;</span><span class="p">],</span><span class="mi">20</span><span class="p">],[[</span><span class="n">null</span><span class="p">,</span><span class="s">&quot;foobar&quot;</span><span class="p">],</span><span class="mi">3</span><span class="p">]]]</span>
</pre></div>


<p>Le serveur de vue répond :</p>
<div class="codehilite"><pre><span class="p">[</span><span class="mi">33</span><span class="p">]</span>
</pre></div>


<p>Attention: même si le serveur de vue reçoit les résultats d'association(map) sous la forme <code>[[key, id-of-doc], value]</code>,la fonction peut être reçue de différentes manières. Par exemple, le serveur de vue Javascript applique les fonctions sur la liste des clés et sur la liste des valeurs.</p>
<h3 id="rereduce">rereduce</h3>
<h3 id="log">log</h3>
<p>À n'importe quel moment, le serveur de vue peut envoyer des informations qui seront stockées dans le serveur de log de CouchDB. Cela est réalisé par l'envoi d'un objet spécial avec un seul champ <code>log</code> sur une ligne à part.</p>
<p>Le serveur de vue envoie :</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s">&quot;log&quot;</span><span class="p">:</span><span class="s">&quot;A kuku!&quot;</span><span class="p">}</span>
</pre></div>


<p>CouchDB ne répond rien.</p>
<p>La ligne suivante apparaitra dans le fichier {{/couchdb/couch.log?action=content|couch.log|width="100%",type="text/html"}}}, mutatis mutandum:</p>
<div class="codehilite"><pre><span class="p">[</span><span class="n">Sun</span><span class="p">,</span> <span class="mi">22</span> <span class="n">Jun</span> <span class="mi">2008</span> <span class="mi">22</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">25</span> <span class="n">GMT</span><span class="p">]</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="p">[</span><span class="s-Regexp">&lt;0.72.0&gt;</span><span class="p">]</span> <span class="n">Query</span> <span class="n">Server</span> <span class="n">Log</span> <span class="n">Message:</span> <span class="n">A</span> <span class="n">kuku</span><span class="o">!</span>
</pre></div>


<p>Si vous utilisez le serveur de vue javascript, vous pouvez obtenir cela en envoyant la fonction <code>log</code> dans votre vue. Pour faire la même chose dans ClCouch, appelez <code>logit</code>.</p>
<h2 id="mise-en-uvres">Mise en œuvres</h2>
<ul>
<li><a href="http://svn.apache.org/repos/asf/incubator/couchdb/trunk/share/server/main.js">JavaScript</a> (CouchDB native)</li>
<li><a href="http://common-lisp.net/cgi-bin/darcsweb/darcsweb.cgi?r=submarine-cl-couch;a=summary">Common Lisp</a></li>
<li><a href="http://jan.prima.de/~jan/plok/archives/93-CouchDb-Views-with-PHP.html">PHP</a></li>
<li><a href="http://theexciter.com/articles/couchdb-views-in-ruby-instead-of-javascript">Ruby</a></li>
<li><a href="http://couchdb-python.googlecode.com/svn/trunk/couchdb/view.py">Python</a></li>
</ul>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>