<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - Nginx_As_a_Reverse_Proxy</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#getting-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>Nginx can serve as a reverse proxy to CouchDB for scenarios such as URL rewriting, load-balancing, access restriction, etc. </p>
<p>Here's a basic excerpt from an nginx config file in <nginx config directory>/sites-available/default. This will proxy all requests from <a href="http://domain.com/...">http://domain.com/...</a> to http://localhost:5984/...</p>
<div class="codehilite"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
                <span class="n">proxy_pass</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5984</span><span class="p">;</span>
                <span class="n">proxy_redirect</span> <span class="n">off</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="nv">$host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>


<h2 id="reverse-proxy-for-a-subdirectory">Reverse proxy for a subdirectory</h2>
<p>Here's an excerpt of a basic nginx configuration that proxies the URL "http://domain.com/couchdb" to "http://localhost:5984" so that requests appended to the subdirectory, such as "http://domain.com/couchdb/db1/doc1" are proxied to "http://localhost:5984/db1/doc1".</p>
<div class="codehilite"><pre><span class="n">location</span> <span class="o">/</span><span class="n">couchdb</span> <span class="p">{</span>
                <span class="n">rewrite</span> <span class="sr">/couchdb/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span> <span class="o">/</span><span class="nv">$1</span> <span class="n">break</span><span class="p">;</span>
                <span class="n">proxy_pass</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5984</span><span class="p">;</span>
                <span class="n">proxy_redirect</span> <span class="n">off</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="nv">$host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>


<h3 id="known-test-suite-issue-with-reverse-proxy-from-subdirectory-url">Known Test Suite issue with reverse proxy from subdirectory URL</h3>
<p>If the reverse proxy configuration also rewrites the URL for a subdirectory, the test suite will fail because it relies on the absolute root path for HTTP requests. This is a known issue and a patch has been submitted by Jack Moffitt at <a href="https://issues.apache.org/jira/browse/COUCHDB-321.">https://issues.apache.org/jira/browse/COUCHDB-321.</a> </p>
<h2 id="authentication-with-reverse-proxy">Authentication with reverse proxy</h2>
<p>Here's a sample config setting with basic authentication enabled:</p>
<div class="codehilite"><pre>        <span class="n">location</span> <span class="o">/</span><span class="n">couchdb</span> <span class="p">{</span>
                <span class="n">auth_basic</span> <span class="s">&quot;Restricted&quot;</span><span class="p">;</span>
                <span class="n">auth_basic_user_file</span> <span class="n">htpasswd</span><span class="p">;</span>
                <span class="n">rewrite</span> <span class="sr">/couchdb/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span> <span class="o">/</span><span class="nv">$1</span> <span class="n">break</span><span class="p">;</span>
                <span class="n">proxy_pass</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5984</span><span class="p">;</span>
                <span class="n">proxy_redirect</span> <span class="n">off</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="nv">$host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>


<h3 id="issues-with-reverse-proxy-authentication">Issues with reverse proxy authentication</h3>
<p>Enabling basic authentication in Nginx will pass the HTTP authentication header to CouchDB, invoking its authentication handler as well. This configuration causes the Nginx basic authentication prompt to appear in the browser, followed by a second authentication prompt from Couchdb, even if CouchDB authentication is not enabled. </p>
<p>You can either use the same username and password combinations for both Nginx and CouchDb, or set CouchDB to use the null_authentication_handler.</p>
<div class="codehilite"><pre><span class="k">[httpd]</span>
<span class="na">authentication_handler</span> <span class="o">=</span> <span class="s">{couch_httpd, null_authentication_handler}</span>
</pre></div>


<p>Note: As an Nginx newbie, it's probable that the original author of this wiki post just didn't know which headers to suppress or how to suppress them :-) I tried "proxy_hide_header Authorization" and "proxy_hide_header WWW-Authenticate".</p>
<p>Note 2: While "proxy_hide_header" does not work, setting the header Authorization to "" seems to work.</p>
<div class="codehilite"><pre>  <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">auth_basic</span>            <span class="s">&quot;CouchDB Admin&quot;</span><span class="p">;</span>
    <span class="n">auth_basic_user_file</span>  <span class="sr">/etc/</span><span class="n">nginx</span><span class="o">/</span><span class="n">passwd</span><span class="p">;</span>
    <span class="n">proxy_pass</span> <span class="n">http:</span><span class="sr">//</span><span class="n">localhost:5984</span><span class="p">;</span>
    <span class="n">proxy_redirect</span> <span class="n">off</span><span class="p">;</span>
    <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="nv">$host</span><span class="p">;</span>
    <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
    <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    <span class="n">proxy_set_header</span> <span class="n">Authorization</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>