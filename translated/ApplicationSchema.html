<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - ApplicationSchema</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <p>A simple example of a CouchDB application schema.</p>
<p>The way CouchDB works is still a bit cryptic for many of us coming from the RDBMS world. So the idea of this page is to write the schema of a typical application the RDBMS way and rewrite it the Document oriented way. I was thinking about a simple blog application:</p>
<ul>
<li>Users can post many articles</li>
<li>Articles can have many comments</li>
<li>Articles can have many tags and tags can have many articles</li>
</ul>
<h2 id="rdbms-schema">RDBMS Schema</h2>
<ul>
<li>Users (<em>id</em>, <em>name</em>, <em>password</em>)</li>
<li>Articles (<em>id</em>, <em>title</em>, <em>body</em>, <em>posted_on</em>, <em>user_id</em>) (<em>user_id</em> being a foreign key)</li>
<li>Comments (<em>id</em>, <em>title</em>, <em>body</em>, <em>posted_on</em>, <em>user_id</em>, ''article_id') (<em>user_id</em> and <em>article_id</em> being foreign keys)</li>
<li>Tags (<em>id</em>, <em>name</em>)</li>
<li>tags_associations(<em>id</em>, <em>article_id</em>, <em>tag_id</em>, <em>user_id</em>)</li>
</ul>
<h2 id="relevant-threads">Relevant Threads</h2>
<p>This part needs to be expanded by people who better understand the subject.</p>
<p>This thread describes how to manage comments:</p>
<ul>
<li><a href="http://groups.google.com/group/couchdb/browse_thread/thread/84cf1bb522d1fbbf">Question/Concern: Document Sizes</a></li>
</ul>
<p>These threads describe how to manage tags:</p>
<ul>
<li><a href="http://groups.google.com/group/couchdb/browse_thread/thread/84cf1bb522d1fbbf/c9bf8e95e421b675?lnk=gst&q=patcito&rnum=3#c9bf8e95e421b675">Question/Concern: Document Sizes</a></li>
<li><a href="http://groups.google.com/group/couchdb/browse_thread/thread/a11521505db8eb3c/07c29b951c4707e1#07c29b951c4707e1">Basic Application Schema Example for the wiki</a></li>
</ul>
<h2 id="couchdb-schema">CouchDB Schema</h2>
<p>These examples use the database <em>blog</em>.</p>
<h3 id="data-storage">Data Storage</h3>
<h4 id="users">Users</h4>
<div class="codehilite"><pre><span class="err">_id:</span> <span class="err">autogenerated_user_id1</span>
<span class="err">type:</span> <span class="err">&quot;user&quot;</span>
<span class="err">name:</span> <span class="err">&quot;J.</span> <span class="err">D.</span> <span class="err">Citizen&quot;</span>
<span class="err">password:</span> <span class="err">&quot;qwerty&quot;</span>
</pre></div>


<h4 id="articles">Articles</h4>
<div class="codehilite"><pre><span class="err">_id:</span> <span class="err">autogenerated_article_id1</span>
<span class="err">user_id:</span> <span class="err">autogenerated_user_id1</span>
<span class="err">type:</span> <span class="err">&quot;article&quot;</span>
<span class="err">title:</span> <span class="err">&quot;RDBMSs</span> <span class="err">SUCK</span> <span class="err">OMG&quot;</span>
<span class="err">body:</span> <span class="err">&quot;I</span> <span class="err">thought</span> <span class="err">what</span> <span class="err">I&#39;d</span> <span class="err">do</span> <span class="err">was,</span> <span class="err">I&#39;d</span> <span class="err">pretend</span> <span class="err">I</span> <span class="err">was</span> <span class="err">one</span> <span class="err">of</span> <span class="err">those</span> <span class="err">deaf-</span>
<span class="err">mutes.&quot;</span>
<span class="err">created:</span> <span class="err">&quot;Fri</span> <span class="err">Oct</span> <span class="err">12</span> <span class="err">04:46:58</span> <span class="err">+1000</span> <span class="err">2007&quot;</span>
<span class="err">comments:</span> <span class="err">comment_id1,</span> <span class="err">comment_id2,</span> <span class="err">etc</span>
<span class="err">tags:</span> <span class="err">[</span> <span class="err">&quot;rdbms&quot;,</span> <span class="err">&quot;things</span> <span class="err">that</span> <span class="err">suck&quot;</span> <span class="err">]</span>
</pre></div>


<h4 id="comments">Comments</h4>
<div class="codehilite"><pre><span class="err">_id:</span> <span class="err">autogenerated_comment_id1</span>
<span class="err">article_id:</span> <span class="err">autogenerated_article_id1</span>
<span class="err">user_id:</span> <span class="err">autogenerated_user_id2</span>
<span class="err">type:</span> <span class="err">&quot;comment&quot;</span>
<span class="err">title:</span> <span class="err">&quot;i</span> <span class="err">liek</span> <span class="err">ur</span> <span class="err">blog&quot;</span>
<span class="err">body:</span> <span class="err">&quot;i</span> <span class="err">liek</span> <span class="err">ur</span> <span class="err">blog</span> <span class="err">a</span> <span class="err">lot</span> <span class="err">LOL.</span> <span class="err">please</span> <span class="err">ad</span> <span class="err">me</span> <span class="err">on</span> <span class="err">my</span> <span class="err">space.</span> <span class="err">clik</span> <span class="err">hear</span> <span class="err">for</span> <span class="err">hot</span> <span class="err">girl</span> <span class="err">action</span> <span class="err">LOL&quot;</span>
<span class="err">created:</span> <span class="err">&quot;Fri</span> <span class="err">Oct</span> <span class="err">12</span> <span class="err">04:46:59</span> <span class="err">+1000</span> <span class="err">2007&quot;</span>
</pre></div>


<p>Bear in mind that due to the flat nature of the document storage that there are no "tables" to do a SELECT from. Most of the real power of CouchDB is in it's views.</p>
<h3 id="views">Views</h3>
<p>Views are be stored into design documents for grouping and giving a sense of structure. Design documents are regular documents in CouchDB, it knows they are design documents because you preface the document's <em>_id</em> attr with <em>_design/</em>.</p>
<p>Let's add a group of views for our tags. Everybody wants to be able to fetch all documents tagged <em>rdbms</em> so lets add a view that will get us there.</p>
<h4 id="_designtags">_design/tags</h4>
<div class="codehilite"><pre><span class="s">&quot;views&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s">&quot;to_docs&quot;</span><span class="p">:</span> <span class="s">&quot;</span>
<span class="s">      function(doc) {</span>
<span class="s">        for( var i=0; i &lt; doc.tags.length; i++) {</span>
<span class="s">          map(doc.tags[i], null);</span>
<span class="s">        }</span>
<span class="s">      }&quot;</span>
<span class="p">}</span>
</pre></div>


<p>This view would be accessed by going to <em>/blog/_design/tags/to_docs</em>. The returned content would look like:</p>
<div class="codehilite"><pre><span class="p">{</span><span class="s">&quot;view&quot;</span><span class="p">:</span><span class="s">&quot;_design/tags/to_docs_inc&quot;</span><span class="p">,</span><span class="s">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="s">&quot;offset&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
 <span class="s">&quot;rows&quot;</span><span class="p">:[</span>
  <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;autogenerated_article_id1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;684343246&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;things that suck&quot;</span><span class="p">},</span>
  <span class="p">{</span><span class="s">&quot;_id&quot;</span><span class="p">:</span><span class="s">&quot;autogenerated_article_id1&quot;</span><span class="p">,</span><span class="s">&quot;_rev&quot;</span><span class="p">:</span><span class="s">&quot;684343246&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;rdbms&quot;</span><span class="p">}</span>
</pre></div>


<p>Note, 2 rows returned for the same article. This is intended. CouchDB will let us filter the data in our views a bit with extra query parameters. Going to <em>/blog/_design/tags/to_docs?key="rdbms"</em> yields only documents tagged <em>rdbms</em>.</p>
<p>Say we're returning a lot of records here and want to reduce them by including the title (or if no title exists, the name) attribute of the thing that was tagged along with the results. Change the following line in the <em>to_docs</em> query above:</p>
<div class="codehilite"><pre><span class="sr">//</span> <span class="nb">map</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">null</span><span class="p">);</span>
<span class="sr">//</span> <span class="n">becomes</span>
<span class="nb">map</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">doc</span><span class="o">.</span><span class="n">title</span> <span class="o">||</span> <span class="n">doc</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
</pre></div>


<p>Optionally, this view could be named to_docs_with_title so as to be available only if the extra data is desired.</p>
<p>Using the sample view given above many other views would likely be implemented. I give only a few sample URLs as follows, implementation is left as an exercise:</p>
<ul>
<li>/blog/_design/comments/on_article?key="autogenerated_article_id1"</li>
<li>/blog/_design/comments/by_user?key="autogenerated_user_id1"</li>
<li>/blog/_design/articles/by_user?key="autogenerated_user_id1"</li>
<li>/blog/_design/articles/by_date?startkey="date1"&amp;endkey="date2"</li>
</ul>
<p>I'm not sure this last one is possible, how does CouchDB handle date indexing?</p>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>