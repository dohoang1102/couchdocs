<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - RegénérationVuesÀlaMiseAjour</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
        <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul>
        
</div>
      <div id="content">
  <!-- #language fr -->

<h1>Mettre à jour les vues lors de l'enregistrement d'un document</h1>
<p>Par défaut CouchDB regénère les vues la première fois qu'elles sont appelées. Ce comportement est adéquat pour la plupart des cas dans la mesure où il optimise l'utilisation des resources sur le serveur de base de données.</p>
<p>Mais  dans certains cas, il est préférables d'avoir rapidement des vues à jour malgré le coût créée par une mise à jour systématique à chaque fois que le serveur reçoit une mise à jour. On peut réaliser cela en fournissant un script de mise à jour qui appelle les vues lorsque cela est nécessaire.</p>
<h2>Exemple utilisant ruby</h2>
<h3>couch.ini</h3>
<p>Ajoutez la lignes suivante au fichier couch.ini 
        DbUpdateNotificationProcess=/PATH/TO/view_updater.rb</p>
<h3>view_updater.rb</h3>
<p>Le script suivant met à jour les vues toutes les 10 mises à jour reçues  par la base de données ou une fois / secondes lorsque le nombre d'enregistrement est important 
    <!-- #!/usr/bin/ruby --></p>
<pre><code>&lt;!-- ################### --&gt;
&lt;!-- # CONF            # --&gt;
&lt;!-- ################### --&gt;

&lt;!-- # The smallest amount of changed documents before the views are updated --&gt;

MIN_NUM_OF_CHANGED_DOCS = 10

&lt;!-- # URL to the DB on the CouchDB server --&gt;

URL = "http://localhost:5984"

&lt;!-- # Set the minimum pause between calls to the database --&gt;

PAUSE = 1 # seconds

&lt;!-- # One entry for each design document --&gt;
&lt;!-- # in each database --&gt;

VIEWS = {"DATABASE_NAME"  =&gt; ["list_of/design_documents",
                              "another/design_document"],
         "recipes"        =&gt; ["category/most_popular"],
         "ingredients"    =&gt; ["by/price"]}

&lt;!-- ################### --&gt;
&lt;!-- # RUNTIME         # --&gt;
&lt;!-- ################### --&gt;

run = true
number_of_changed_docs = {}

threads = []

&lt;!-- # Updates the views --&gt;

threads &lt;&lt; Thread.new do

  while run do

    number_of_changed_docs.each_pair do |db_name, number_of_docs|
      if number_of_docs &gt;= MIN_NUM_OF_CHANGED_DOCS

        # Reset the value
        number_of_changed_docs[db_name] = 0

        # If there are views in the database, get them
        if VIEWS[db_name]
          VIEWS[db_name].each do |view|
            `curl #{URL}/#{db_name}/_view/#{view}?count=0`
          end  
        end

      end
    end

    # Pause before starting over again
    sleep PAUSE

  end

end

&lt;!-- # Receives the update notification from CouchDB --&gt;

threads &lt;&lt; Thread.new do

  while run do

    puts "Waiting for input:"
    update_call = gets

    # When CouchDB exits the script gets called with
    # a never ending series of nil
    if update_call == nil
      run = false
    else

      # Get the database name out of the call data
      # The data looks somethind like this:
      # {"type":"updated","db":"DB_NAME"}\n
      update_call =~ /\"db\":\"(\w+)\"/
      database_name = $1

      # Set to 0 if it hasn't been initialized before
      number_of_changed_docs[$1] ||= 0

      # Add one pending changed document to the list of documents
      # in the DB
      number_of_changed_docs[$1] += 1

    end

  end

end

&lt;!-- # Good bye --&gt;

threads.each {|thr| thr.join}
</code></pre>
<p>view_updater.rb doit être exécutable par CouchDB .</p>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>