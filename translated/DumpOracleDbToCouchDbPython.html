<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CouchDocs - DumpOracleDbToCouchDbPython</title>
    <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../css/code_highlight.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="wrapper"> 
      <div id="header">
          <h1><a href="/">CouchDocs</a></h1>
      </div>
      <div id="menu">
  <strong>Navigation</strong>
<ul>
  <li><a href="FrontPage.html">Overview</a></li>
  <li><a href="FrontPage.html#using-couchdb">Using CouchDB</a></li>
  <li><a href="FrontPage.html#when-things-go-wrong">When Things Go Wrong</a></li>
  <li><a href="FrontPage.html#community">Community</a></li>
  <li><a href="FrontPage.html#get-involved">Get Involved</a></li>
  <li><a href="FrontPage.html#books">Books</a></li>
</ul>

<strong>Short Cuts</strong>
<ul>
  <li><a href="Reference.html">Reference</a></li>
  <li><a href="Frequently_asked_questions.html">FAQ</a></li>
</ul>


      <!-- <ul>
        <li>Overview</li>
        <li>Installation</li>
        <li>Introduction</li>
        <li>Conventions</li>
        <li>
          Sections
          <ul>
            <li>Databases</li>
            <li>
              Documents
              <ul>
                <li>Design</li>
                <li>Local</li>
              </ul>
            </li>
            <li>Views</li>
            <li>Rendering</li>
            <li>Configuration</li>
            <li>Statistics</li>
            <li>Security</li>
          </ul>
        </li>
        <li>API Reference</li>
        <li>Client Libraries</li>
        <li>How do I?</li>
        <li>FAQ</li>
      </ul> -->
        
</div>
      <div id="content">
  <h1 id="unique-values-in-sql-table-converted-to-individual-documents">Unique Values in SQL Table Converted to Individual Documents</h1>
<p>Cro-Magnon simple python script which will take the contents of an SQL table and place it into CouchDB.</p>
<p>This particular example depends on the SQL table having one unique field. The values in the unique field become individual documents in the CouchDB database.</p>
<p>You'll need the python couchdb module from http://code.google.com/p/couchdb-python/ , plus whatever DBAPI2.0 compliant module you use to connect to your favorite SQL database.This example uses Oracle, but it should be trivial to convert.</p>
<p>This is probably not what you want. :-)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre></div></td><td class="code"><div class="codehilite"><pre><span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c">#!/usr/bin/env python --&gt;</span>

<span class="kn">import</span> <span class="nn">couchdb</span><span class="o">,</span> <span class="nn">cx_Oracle</span><span class="o">,</span> <span class="nn">ConfigParser</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">datetime</span>

<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># Convert a list of (sql tables, unique identifiers) into couchDB documents --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># Simply figure out which db you wish to import from, and a series of tables, --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># with unique fields you&#39;d like to have them --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># indexed by, put them into the list of tuples below and let fly. --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># I store all my config stuf in an ini file locally.  you&#39;ll have to handle --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># your own connection to your db. --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># This is pretty quick-and-dirty and I don&#39;t reccomend it for any sort of --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># production anything at all! :-) --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># Should work for any db api 2 compliant sql database. --&gt;</span>
<span class="o">&lt;</span><span class="err">!</span><span class="o">--</span> <span class="c"># Script guaranteed 100% slower than christmas. --&gt;</span>

<span class="n">db_name</span> <span class="o">=</span> <span class="s">&#39;mydatabase&#39;</span>
<span class="n">table_names</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s">&#39;TABLE_NAME0&#39;</span><span class="p">,</span> <span class="s">&#39;UNIQUE_FIELD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;TABLE_NAME1&#39;</span><span class="p">,</span> <span class="s">&#39;UNIQUE_FIELD&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;TABLE_NAME2&#39;</span><span class="p">,</span> <span class="s">&#39;UNIQUE_FIELD&#39;</span><span class="p">)</span> <span class="p">]</span>

<span class="k">class</span> <span class="nc">GrabbyMitts</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_</span>\<span class="n">_init_</span>\<span class="n">_</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span> <span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span> <span class="p">[</span> <span class="s">&quot;sqlgen.ini&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/.sqlgen.ini&quot;</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>

        <span class="c"># oracle connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Oracle&quot;</span><span class="p">,</span> <span class="s">&quot;login&quot;</span><span class="p">)</span> <span class="p">)</span>

        <span class="c"># couchdb location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">couch</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span> <span class="s">&quot;http://localhost:5984/&quot;</span> <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couch</span><span class="o">.</span><span class="n">create</span><span class="p">(</span> <span class="n">db_name</span> <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">couch</span><span class="p">[</span> <span class="n">db_name</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c"># get a description of a given table</span>
        <span class="c"># returns the &quot;header&quot; information in list</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;select * from </span><span class="si">%s</span><span class="s"> where 1=0&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="n">query</span> <span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span> <span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">description</span>

    <span class="k">def</span> <span class="nf">uniques</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c"># unique value in sql table to create couchdb document ID</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;select </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">mykey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="n">query</span> <span class="p">)</span>
        <span class="n">myuniques</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">myuniques</span>

    <span class="k">def</span> <span class="nf">updateCouch</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">table_and_key</span> <span class="p">):</span>
        <span class="c"># populate or update couchdb documents using sql table and unique</span>
        <span class="c"># identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mykey</span> <span class="o">=</span> <span class="n">table_and_key</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="p">)</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            select </span><span class="si">%s</span><span class="s"></span>
<span class="s">            from </span><span class="si">%s</span><span class="s"></span>
<span class="s">            where </span><span class="si">%s</span><span class="s">=:myunique&quot;&quot;&quot;&quot;&quot;</span><span class="o">%</span><span class="p">(</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">header</span> <span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">mykey</span> <span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span> <span class="n">query</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">myunique</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">{</span> <span class="s">&quot;myunique&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniques</span><span class="p">()</span> <span class="p">]:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="n">myunique</span> <span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">[</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">header</span><span class="p">,</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="c"># mop up datetime objects as they occour, since json cries foul.</span>
            <span class="c"># will probably need to convert to unix epochal time</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">entry</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">entry</span><span class="p">[</span> <span class="n">k</span> <span class="p">]</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myunique</span><span class="p">[</span> <span class="s">&#39;myunique&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myunique</span><span class="p">[</span> <span class="s">&#39;myunique&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myunique</span><span class="p">[</span> <span class="s">&#39;myunique&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="n">doc</span><span class="p">[</span> <span class="n">k</span> <span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span> <span class="n">k</span> <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myunique</span><span class="p">[</span> <span class="s">&#39;myunique&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">doc</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">_</span>\<span class="n">_name__</span> <span class="o">==</span> <span class="s">&quot;_\_main_\_&quot;</span><span class="p">:</span>
    <span class="n">gm</span> <span class="o">=</span> <span class="n">GrabbyMitts</span><span class="p">(</span> <span class="n">db_name</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
        <span class="n">gm</span><span class="o">.</span><span class="n">updateCouch</span><span class="p">(</span> <span class="n">table_name</span> <span class="p">)</span>
</pre></div>
</td></tr></table>

<h1 id="unique-values-in-sql-table-converted-to-a-single-document">Unique Values in SQL Table Converted to a Single Document</h1>
<p>Differs from above in that it places all table data into a single document.</p>
<div class="codehilite"><pre><span class="nb">select</span> <span class="n">username</span><span class="p">,</span> <span class="n">shoe_size</span><span class="p">,</span> <span class="n">nostril_count</span><span class="p">,</span> <span class="n">owns_weather_ballon</span> <span class="n">from</span> <span class="n">humans</span><span class="p">;</span>

<span class="n">username</span> <span class="o">|</span> <span class="n">shoe_size</span> <span class="o">|</span> <span class="n">nostril_count</span> <span class="o">|</span> <span class="n">owns_weather_balloon</span>

<span class="n">cletus</span>        <span class="o">|</span> <span class="mi">10</span>            <span class="o">|</span> <span class="mi">3</span>                    <span class="o">|</span> <span class="n">y</span>
</pre></div>


<p>becomes:</p>
<div class="codehilite"><pre><span class="n">db</span><span class="p">[</span> <span class="s">&#39;humans&#39;</span> <span class="p">]{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;cletus&#39;</span><span class="p">,</span><span class="s">&#39;shoe_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span><span class="s">&#39;nostril_count&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="s">&#39;owns_weather_balloon&#39;</span><span class="p">:</span> <span class="s">&#39;y&#39;</span> <span class="p">}</span>
</pre></div>


<p>This probably isn't what you want either! Script does no checking to make sure that your particular value is unique.</p>
<div class="codehilite"><pre><span class="o">&lt;!--</span> <span class="c1"># HEY! THIS VERSION CAN MAKE A MOTHER-HUGE DOCUMENT! KNOW WHAT YOU ARE DOING!!! --&gt;</span>
<span class="o">&lt;!--</span> <span class="c1"># Convert a list of (sql tables, unique identifiers) into a single couchDB document --&gt;</span>
<span class="o">&lt;!--</span> <span class="c1"># Switch out with updateCouch() above --&gt;</span>

    <span class="n">def</span> <span class="n">updateCouch</span><span class="p">(</span> <span class="n">self</span><span class="p">,</span> <span class="n">table_and_key</span> <span class="p">):</span>
        <span class="c1"># populate or update couchdb documents using sql table and unique</span>
        <span class="c1"># identifier</span>
        <span class="c1"># HEY! THIS CAN MAKE A MOTHER-HUGE DOCUMENT! KNOW WHAT YOU ARE DOING!!!</span>
        <span class="n">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">self</span><span class="o">.</span><span class="n">mykey</span> <span class="o">=</span> <span class="n">table_and_key</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="n">cx_Oracle</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span> <span class="n">self</span><span class="o">.</span><span class="n">connection</span> <span class="p">)</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="n">description</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            select %s</span>
<span class="s">            from %s</span>
<span class="s">            order by %s&quot;&quot;&quot;&quot;&quot;</span><span class="nv">%</span><span class="err">(</span> <span class="err">&quot;</span><span class="p">,</span> <span class="s">&quot;.join( header ),</span>
<span class="s">                                    self.table_name,</span>
<span class="s">                                    self.mykey )</span>

<span class="s">        cursor.execute( query )</span>
<span class="s">        results = dict(</span>
<span class="s">                [ ( str( row[0] ), dict(</span>
<span class="s">                    [ (k, v) for k, v in zip( header, row ) ]</span>
<span class="s">                    ) ) for row in cursor.fetchall()</span>
<span class="s">                ] )</span>

<span class="s">        # clean up any datetime fields</span>
<span class="s">        for row in results:</span>
<span class="s">            for field in results[ row ]:</span>
<span class="s">                if isinstance( results[ row ][ field ], datetime.datetime ):</span>
<span class="s">                    results[ row ][ field ] = &quot;</span><span class="nv">%s</span><span class="err">&quot;</span><span class="nv">%results</span><span class="p">[</span> <span class="n">row</span> <span class="p">][</span> <span class="n">field</span> <span class="p">]</span>
        <span class="n">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span> <span class="n">self</span><span class="o">.</span><span class="n">table_name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">results</span>

        <span class="n">cursor</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
</pre></div>
</div>
      <div id="footer">
        <p>Hosted on <a href="http://github.com/">Github</a></p>
      </div>
    </div>
  </body>
</html>